<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Builder - Past Paper Word Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        .word-highlight {
            background-color: #FEF3C7;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }
        .dark .word-highlight {
            background-color: #92400E;
            color: #FEF3C7;
        }
        .drop-zone-active {
            border-color: #5D5CDE !important;
            background-color: rgba(93, 92, 222, 0.1) !important;
        }
    </style>
</head>
<body class="h-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-primary shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <img src="https://pfst.cf2.poecdn.net/base/image/aefa3033d874492d44b304df60b4d097d01dbdf5734d75fe0655d349c6e59a62?w=304&h=340" 
                             alt="School Logo" 
                             class="h-12 w-auto object-contain bg-white rounded-lg p-1 shadow-sm">
                        <h1 class="text-2xl font-bold text-white">üìö Vocabulary Builder</h1>
                    </div>
                    
                    <!-- Navigation Tabs -->
                    <nav class="flex space-x-4">
                        <button id="mainPageTab" class="px-4 py-2 bg-white bg-opacity-20 text-white rounded-md text-sm hover:bg-opacity-30 transition-colors">
                            üè† Main
                        </button>
                        <button id="generatePageTab" class="px-4 py-2 text-blue-100 rounded-md text-sm hover:bg-white hover:bg-opacity-20 transition-colors">
                            ‚ú® Generate Articles
                        </button>
                        <button id="practicePageTab" class="px-4 py-2 text-blue-100 rounded-md text-sm hover:bg-white hover:bg-opacity-20 transition-colors">
                            üéØ Practice
                        </button>
                        <button id="chatPageTab" class="px-4 py-2 text-blue-100 rounded-md text-sm hover:bg-white hover:bg-opacity-20 transition-colors">
                            ü§ñ Chat Assistant
                        </button>
                    </nav>
                    
                    <p class="text-blue-100 text-sm">Past Paper Word Extractor</p>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Main Page Content -->
            <div id="mainPage" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column: PDF Upload & Word List -->
                <div class="space-y-6">
                    <!-- PDF Upload Section -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            üìÑ Extract Vocabulary Words
                        </h2>
                        
                        <!-- Tab buttons -->
                        <div class="flex space-x-2 mb-4">
                            <button id="pdfTab" class="px-4 py-2 bg-primary text-white rounded-md text-sm">
                                üìÑ PDF Upload
                            </button>
                            <button id="manualTab" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md text-sm">
                                ‚úèÔ∏è Manual Input
                            </button>
                        </div>

                        <!-- PDF Upload Panel -->
                        <div id="pdfPanel" class="space-y-4">
                            <div id="dropZone" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center transition-all duration-200 hover:border-primary hover:bg-gray-50 dark:hover:bg-gray-700">
                                <input type="file" id="pdfInput" accept=".pdf,.docx" multiple class="hidden">
                                <label for="pdfInput" class="cursor-pointer">
                                    <div class="space-y-2">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">
                                            <span class="font-medium text-primary hover:text-blue-500">Click to upload</span> or drag and drop
                                        </div>
                                        <p class="text-xs text-gray-500">PDF or DOCX files (multiple files supported)</p>
                                        <p class="text-xs text-green-600 dark:text-green-400">üí° Drop multiple files at once!</p>
                                    </div>
                                </label>
                            </div>

                            <div id="extractionProgress" class="hidden">
                                <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-md p-4">
                                    <div class="flex items-center">
                                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary mr-3"></div>
                                        <div class="flex-1">
                                            <p class="text-sm text-blue-800 dark:text-blue-200" id="progressMessage">Processing files...</p>
                                            <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-2 mt-2">
                                                <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                            </div>
                                            <p class="text-xs text-blue-600 dark:text-blue-300 mt-1" id="progressDetails">File 0 of 0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="fileList" class="hidden">
                                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">üìÅ Processing Queue:</h4>
                                <div id="fileQueue" class="space-y-1 max-h-32 overflow-y-auto">
                                </div>
                            </div>
                        </div>

                        <!-- Manual Input Panel -->
                        <div id="manualPanel" class="hidden space-y-4">
                            <div class="bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded-md p-4">
                                <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                    üí° <strong>How to use manual input:</strong><br>
                                    1. Copy text from your PDF using any PDF reader<br>
                                    2. Paste it in the text area below<br>
                                    3. Click "Extract Words" to build your vocabulary list
                                </p>
                            </div>
                            
                            <textarea id="manualTextInput" placeholder="Paste the text from your past paper here. You can copy the text from any PDF reader and paste it here. The app will extract vocabulary words from this text..."
                                      class="text-base w-full h-48 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 placeholder-gray-500 resize-none"></textarea>
                            
                            <button id="extractFromText" class="w-full bg-primary hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors">
                                üìù Extract Words from Text
                            </button>
                        </div>

                        <div class="mt-4 flex space-x-2">
                            <input type="number" id="minWordLength" value="4" min="2" max="20" 
                                   class="text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 w-20">
                            <label class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                Minimum word length
                            </label>
                        </div>
                    </div>

                    <!-- Word List Section -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold flex items-center">
                                üìù Extracted Word List
                            </h2>
                            <span id="wordCount" class="text-sm text-gray-500 bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">
                                0 words
                            </span>
                        </div>
                        
                        <div id="wordList" class="max-h-96 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-md p-4 bg-white dark:bg-gray-700">
                            <p class="text-gray-500 text-center py-8">Upload a PDF to extract vocabulary words</p>
                        </div>

                        <!-- Export Options -->
                        <div id="exportOptions" class="hidden mt-4 space-y-3">
                            <div class="flex space-x-2">
                                <select id="sortOption" class="text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 flex-1">
                                    <option value="frequency">Sort by Frequency</option>
                                    <option value="alphabetical">Sort Alphabetically</option>
                                    <option value="length">Sort by Length</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button id="exportPDF" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-md transition-colors text-sm">
                                    üìÑ Export PDF
                                </button>
                                <button id="exportDOCX" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors text-sm">
                                    üìù Export DOCX
                                </button>
                            </div>
                            
                            <button id="clearWords" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md transition-colors text-sm">
                                üóëÔ∏è Clear Word List
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Article Processing -->
                <div class="space-y-6">
                    <!-- Article Input Section -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            üì∞ Article/Text for Practice
                        </h2>
                        
                        <!-- Article Input Tabs -->
                        <div class="flex space-x-2 mb-4">
                            <button id="articleManualTab" class="px-3 py-1 bg-primary text-white rounded-md text-sm">
                                ‚úèÔ∏è Manual Input
                            </button>
                            <button id="articleFileTab" class="px-3 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md text-sm">
                                üìÑ Upload File
                            </button>
                        </div>

                        <!-- Manual Input Panel -->
                        <div id="articleManualPanel">
                            <textarea id="articleInput" placeholder="Paste a newspaper article or any text here. The app will replace simpler words with vocabulary words from your word list to create a practice exercise for students..."
                                      class="text-base w-full h-40 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 placeholder-gray-500 resize-none"></textarea>
                        </div>

                        <!-- File Upload Panel -->
                        <div id="articleFilePanel" class="hidden">
                            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center">
                                <input type="file" id="articleFileInput" accept=".pdf,.docx,.txt" class="hidden">
                                <label for="articleFileInput" class="cursor-pointer">
                                    <div class="space-y-2">
                                        <svg class="mx-auto h-8 w-8 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">
                                            <span class="font-medium text-primary hover:text-blue-500">Upload article</span>
                                        </div>
                                        <p class="text-xs text-gray-500">PDF, DOCX, or TXT files</p>
                                    </div>
                                </label>
                            </div>
                            
                            <div id="articleProgress" class="hidden mt-2">
                                <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-md p-3">
                                    <div class="flex">
                                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"></div>
                                        <p class="text-sm text-blue-800 dark:text-blue-200">Processing article...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex flex-wrap gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="preserveProperNouns" checked class="mr-2 text-primary">
                                <span class="text-sm">Preserve proper nouns</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="highlightChanges" checked class="mr-2 text-primary">
                                <span class="text-sm">Highlight replaced words</span>
                            </label>
                        </div>
                        
                        <button id="processArticle" disabled 
                                class="mt-4 w-full bg-primary hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white py-2 px-4 rounded-md transition-colors">
                            Transform Text for Practice
                        </button>
                    </div>

                    <!-- Processed Article Section -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center">
                            ‚ú® Practice Material
                        </h2>
                        
                        <div id="processedArticle" class="min-h-40 max-h-96 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-md p-4 bg-white dark:bg-gray-700 whitespace-pre-wrap">
                            <p class="text-gray-500 text-center py-8">Process an article to see the practice material here</p>
                        </div>

                        <div id="replacementStats" class="hidden mt-4 p-3 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-md">
                            <p class="text-sm text-blue-800 dark:text-blue-200">
                                <span id="replacementCount">0</span> words replaced with vocabulary words
                            </p>
                        </div>

                        <button id="copyToClipboard" class="hidden mt-4 w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition-colors">
                            üìã Copy Practice Material
                        </button>
                    </div>
                </div>
            </div>

            <!-- Article Generation Page -->
            <div id="generatePage" class="hidden">
                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Header Section -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h2 class="text-2xl font-semibold mb-4 flex items-center">
                            ‚ú® AI Article Generator
                        </h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            Generate practice articles using your extracted vocabulary words. Perfect for creating custom reading materials for students.
                        </p>
                        
                        <div id="generateWordCount" class="mb-4 p-3 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-md">
                            <p class="text-sm text-blue-800 dark:text-blue-200">
                                üìù <span id="availableWords">0</span> vocabulary words available for generation
                            </p>
                        </div>
                    </div>

                    <!-- Generation Settings -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">üìã Article Settings</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Article Length</label>
                                <select id="articleLength" class="text-base w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                                    <option value="short">Short (100-150 words)</option>
                                    <option value="medium" selected>Medium (200-300 words)</option>
                                    <option value="long">Long (400-500 words)</option>
                                    <option value="extended">Extended (600-800 words)</option>
                                    <option value="comprehensive">Comprehensive (1000-1200 words)</option>
                                    <option value="detailed">Detailed (1500-2000 words)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Article Topic</label>
                                <select id="articleTopic" class="text-base w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                                    <option value="education">Education & Learning</option>
                                    <option value="technology">Technology & Innovation</option>
                                    <option value="environment">Environment & Nature</option>
                                    <option value="health">Health & Wellness</option>
                                    <option value="business">Business & Economy</option>
                                    <option value="culture">Culture & Society</option>
                                    <option value="science">Science & Research</option>
                                    <option value="general">General Topics</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium mb-2">Vocabulary Usage Intensity</label>
                            <input type="range" id="vocabIntensity" min="20" max="80" value="40" class="w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>Light (20%)</span>
                                <span>Moderate (40%)</span>
                                <span>Heavy (80%)</span>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex space-x-4">
                            <button id="generateArticle" class="flex-1 bg-primary hover:bg-blue-600 text-white py-3 px-6 rounded-md transition-colors">
                                ‚ú® Generate Article
                            </button>
                            <button id="regenerateArticle" class="hidden flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-md transition-colors">
                                üîÑ Generate Another
                            </button>
                        </div>
                    </div>

                    <!-- Generated Article Display -->
                    <div id="generatedArticleSection" class="hidden bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">üì∞ Generated Article</h3>
                        
                        <div id="generatedArticle" class="border border-gray-200 dark:border-gray-600 rounded-md p-4 bg-white dark:bg-gray-700 min-h-40 max-h-96 overflow-y-auto whitespace-pre-wrap">
                        </div>
                        
                        <div id="generationStats" class="mt-4 p-3 bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-md">
                            <p class="text-sm text-green-800 dark:text-green-200">
                                üìä Article generated with <span id="usedWordsCount">0</span> vocabulary words
                            </p>
                        </div>
                        
                        <div class="mt-4 flex space-x-3">
                            <button id="copyGeneratedArticle" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors">
                                üìã Copy Article
                            </button>
                            <button id="downloadGeneratedArticle" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition-colors">
                                üíæ Download as PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Practice Page -->
            <div id="practicePage" class="hidden">
                <div class="max-w-6xl mx-auto space-y-6">
                    <!-- Practice Header -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h2 class="text-2xl font-semibold mb-4 flex items-center">
                            üéØ Vocabulary Practice Exercises
                        </h2>
                        <p class="text-gray-600 dark:text-gray-400">
                            Interactive exercises to help students practice and master vocabulary words from past papers.
                        </p>
                    </div>

                    <!-- Practice Type Selection -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Choose Practice Type</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <button id="fillBlankPractice" class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary transition-colors">
                                <div class="text-center">
                                    <div class="text-2xl mb-2">üìù</div>
                                    <h4 class="font-semibold mb-2">Fill in the Blanks</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Complete sentences with vocabulary words</p>
                                </div>
                            </button>
                            
                            <button id="matchingPractice" class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary transition-colors">
                                <div class="text-center">
                                    <div class="text-2xl mb-2">üîó</div>
                                    <h4 class="font-semibold mb-2">Word Matching</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Match words with their meanings</p>
                                </div>
                            </button>
                            
                            <button id="multipleChoicePractice" class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary transition-colors">
                                <div class="text-center">
                                    <div class="text-2xl mb-2">‚úÖ</div>
                                    <h4 class="font-semibold mb-2">Multiple Choice</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Choose the correct word for context</p>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Practice Exercise Area -->
                    <div id="practiceExerciseArea" class="hidden bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="practiceTitle" class="text-xl font-semibold">Practice Exercise</h3>
                            <button id="backToPracticeMenu" class="text-primary hover:text-blue-600">‚Üê Back to Menu</button>
                        </div>
                        
                        <div id="practiceContent" class="space-y-4">
                            <!-- Dynamic practice content will be inserted here -->
                        </div>
                        
                        <div id="practiceControls" class="mt-6 flex justify-between items-center">
                            <div id="practiceProgress" class="text-sm text-gray-600 dark:text-gray-400">
                                Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span>
                            </div>
                            <div class="space-x-3">
                                <button id="prevQuestion" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md transition-colors">
                                    ‚Üê Previous
                                </button>
                                <button id="nextQuestion" class="bg-primary hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors">
                                    Next ‚Üí
                                </button>
                                <button id="finishPractice" class="hidden bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition-colors">
                                    ‚úÖ Finish
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Practice Results -->
                    <div id="practiceResults" class="hidden bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">üèÜ Practice Results</h3>
                        
                        <div id="resultsContent" class="space-y-4">
                            <!-- Results will be displayed here -->
                        </div>
                        
                        <div class="mt-6 flex space-x-3">
                            <button id="restartPractice" class="bg-primary hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors">
                                üîÑ Try Again
                            </button>
                            <button id="newPracticeType" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition-colors">
                                üìù New Exercise Type
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Assistant Page -->
            <div id="chatPage" class="hidden">
                <div class="max-w-6xl mx-auto space-y-6">
                    <!-- Chat Header -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h2 class="text-2xl font-semibold mb-4 flex items-center">
                            ü§ñ Smart Chat Assistant
                        </h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            Ask questions about your uploaded articles, vocabulary words, or get help with past papers. I remember everything you've uploaded!
                        </p>
                        
                        <div id="chatStats" class="flex flex-wrap gap-4 text-sm">
                            <div class="bg-blue-50 dark:bg-blue-900 px-3 py-2 rounded-md">
                                üìö <span id="storedArticleCount">0</span> articles stored
                            </div>
                            <div class="bg-green-50 dark:bg-green-900 px-3 py-2 rounded-md">
                                üî§ <span id="storedWordCount">0</span> vocabulary words
                            </div>
                            <div class="bg-purple-50 dark:bg-purple-900 px-3 py-2 rounded-md">
                                üíæ <span id="totalContentSize">0</span> words of content
                            </div>
                        </div>
                    </div>

                    <!-- Chat Interface -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <!-- Chat Messages Area -->
                        <div id="chatMessages" class="bg-white dark:bg-gray-700 rounded-lg h-96 p-4 overflow-y-auto mb-4 border border-gray-200 dark:border-gray-600">
                            <div class="text-center text-gray-500 dark:text-gray-400 mt-20">
                                <div class="text-4xl mb-4">ü§ñ</div>
                                <p class="text-lg font-medium">Welcome to your Smart Assistant!</p>
                                <p class="text-sm mt-2">Ask me anything about your uploaded content:</p>
                                <div class="text-xs mt-3 space-y-1">
                                    <p>‚Ä¢ "What vocabulary words are in [filename]?"</p>
                                    <p>‚Ä¢ "Summarize the content about education"</p>
                                    <p>‚Ä¢ "Find articles containing the word 'research'"</p>
                                    <p>‚Ä¢ "Show me all files uploaded today"</p>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Action Buttons -->
                        <div id="quickActions" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                            <button class="quick-action bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-3 py-2 rounded-md text-sm hover:bg-blue-200 dark:hover:bg-blue-700 transition-colors" data-query="List all my uploaded articles">
                                üìö My Articles
                            </button>
                            <button class="quick-action bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-3 py-2 rounded-md text-sm hover:bg-green-200 dark:hover:bg-green-700 transition-colors" data-query="Show all vocabulary words">
                                üî§ Vocabulary
                            </button>
                            <button class="quick-action bg-purple-100 dark:bg-purple-800 text-purple-800 dark:text-purple-200 px-3 py-2 rounded-md text-sm hover:bg-purple-200 dark:hover:bg-purple-700 transition-colors" data-query="What topics do my articles cover?">
                                üìä Topics
                            </button>
                            <button class="quick-action bg-orange-100 dark:bg-orange-800 text-orange-800 dark:text-orange-200 px-3 py-2 rounded-md text-sm hover:bg-orange-200 dark:hover:bg-orange-700 transition-colors" data-query="Help me practice vocabulary">
                                üéØ Practice Help
                            </button>
                        </div>

                        <!-- Chat Input -->
                        <div class="flex space-x-2">
                            <input type="text" id="chatInput" placeholder="Ask me about your articles, vocabulary, or any questions about past papers..." 
                                   class="text-base flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 placeholder-gray-500">
                            <button id="sendMessage" class="bg-primary hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors flex items-center">
                                <span class="mr-2">Send</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Typing Indicator -->
                        <div id="typingIndicator" class="hidden mt-3 text-sm text-gray-500 dark:text-gray-400">
                            <div class="flex items-center space-x-2">
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                                <span>Assistant is thinking...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">üìÅ Stored Data Management</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-medium mb-2">Recent Articles</h4>
                                <div id="recentArticles" class="space-y-2 max-h-32 overflow-y-auto">
                                    <p class="text-sm text-gray-500">No articles stored yet</p>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-medium mb-2">Storage & Sharing Actions</h4>
                                <div class="space-y-2">
                                    <button id="shareData" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md text-sm transition-colors">
                                        üîó Share My Data
                                    </button>
                                    <button id="loadSharedData" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-md text-sm transition-colors">
                                        üì• Load Shared Data
                                    </button>
                                    <button id="exportAllData" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md text-sm transition-colors">
                                        üíæ Export All Data
                                    </button>
                                    <button id="importDataFile" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-md text-sm transition-colors">
                                        üì§ Import Data File
                                    </button>
                                    <input type="file" id="importFileInput" accept=".json,.txt" class="hidden">
                                    <button id="exportChatHistory" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-md text-sm transition-colors">
                                        üí¨ Export Chat History
                                    </button>
                                    <button id="clearStoredData" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-md text-sm transition-colors">
                                        üóëÔ∏è Clear All Stored Data
                                    </button>
                                </div>
                                
                                <!-- Storage Status -->
                                <div class="mt-4 p-3 bg-gray-100 dark:bg-gray-600 rounded-md">
                                    <h5 class="text-sm font-medium mb-2">Storage Status</h5>
                                    <div class="text-xs text-gray-600 dark:text-gray-300" id="storageStatus">
                                        Calculating storage usage...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let extractedWords = new Set();
        let wordFrequency = {};
        let wordsByPOS = {}; // Store words organized by part of speech

        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // DOM elements
        const pdfInput = document.getElementById('pdfInput');
        const extractionProgress = document.getElementById('extractionProgress');
        const wordList = document.getElementById('wordList');
        const wordCount = document.getElementById('wordCount');
        const clearWords = document.getElementById('clearWords');
        const articleInput = document.getElementById('articleInput');
        const processArticle = document.getElementById('processArticle');
        const processedArticle = document.getElementById('processedArticle');
        const replacementStats = document.getElementById('replacementStats');
        const replacementCount = document.getElementById('replacementCount');
        const copyToClipboard = document.getElementById('copyToClipboard');
        const minWordLength = document.getElementById('minWordLength');

        // New DOM elements for tabs and manual input
        const pdfTab = document.getElementById('pdfTab');
        const manualTab = document.getElementById('manualTab');
        const pdfPanel = document.getElementById('pdfPanel');
        const manualPanel = document.getElementById('manualPanel');
        const manualTextInput = document.getElementById('manualTextInput');
        const extractFromText = document.getElementById('extractFromText');

        // Wait for libraries to load and check availability
        window.addEventListener('load', function() {
            console.log('‚úÖ Page loaded successfully');
            console.log('üìù Using simple word extraction (no external NLP required)');
        });

        // Event listeners
        pdfInput.addEventListener('change', handleMultipleFileUpload);
        clearWords.addEventListener('click', clearWordList);
        processArticle.addEventListener('click', transformArticle);
        copyToClipboard.addEventListener('click', copyPracticeMaterial);
        articleInput.addEventListener('input', updateProcessButton);
        
        // Drag and drop functionality
        setupDragAndDrop();
        
        // Multiple file handling and storage (with fallback)
        let storedArticles = [];
        let fileQueue = [];
        let currentFileIndex = 0;
        
        // Safe localStorage wrapper
        function safeGetFromStorage(key, defaultValue) {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultValue;
            } catch (error) {
                console.log('Storage not available, using memory only');
                return defaultValue;
            }
        }
        
        function safeSaveToStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (error) {
                console.log('Storage not available, data will be lost on page refresh');
                return false;
            }
        }
        
        // Initialize stored articles with fallback
        storedArticles = safeGetFromStorage('vocabularyArticles', []);
        
        // Tab functionality
        pdfTab.addEventListener('click', () => switchTab('pdf'));
        manualTab.addEventListener('click', () => switchTab('manual'));
        extractFromText.addEventListener('click', handleManualExtraction);
        
        // Article input tabs
        document.getElementById('articleManualTab').addEventListener('click', () => switchArticleTab('manual'));
        document.getElementById('articleFileTab').addEventListener('click', () => switchArticleTab('file'));
        document.getElementById('articleFileInput').addEventListener('change', handleArticleFileUpload);

        // Page navigation
        document.getElementById('mainPageTab').addEventListener('click', () => switchPage('main'));
        document.getElementById('generatePageTab').addEventListener('click', () => switchPage('generate'));
        document.getElementById('practicePageTab').addEventListener('click', () => switchPage('practice'));
        document.getElementById('chatPageTab').addEventListener('click', () => switchPage('chat'));

        // Article generation functionality
        document.getElementById('generateArticle').addEventListener('click', handleArticleGeneration);
        document.getElementById('regenerateArticle').addEventListener('click', handleArticleGeneration);
        document.getElementById('copyGeneratedArticle').addEventListener('click', copyGeneratedArticle);
        document.getElementById('downloadGeneratedArticle').addEventListener('click', downloadGeneratedArticle);

        // Practice functionality
        document.getElementById('fillBlankPractice').addEventListener('click', () => startPractice('fillBlank'));
        document.getElementById('matchingPractice').addEventListener('click', () => startPractice('matching'));
        document.getElementById('multipleChoicePractice').addEventListener('click', () => startPractice('multipleChoice'));
        document.getElementById('backToPracticeMenu').addEventListener('click', backToPracticeMenu);
        document.getElementById('prevQuestion').addEventListener('click', previousQuestion);
        document.getElementById('nextQuestion').addEventListener('click', nextQuestion);
        document.getElementById('finishPractice').addEventListener('click', finishPractice);
        document.getElementById('restartPractice').addEventListener('click', restartCurrentPractice);
        document.getElementById('newPracticeType').addEventListener('click', backToPracticeMenu);

        // Global variables for new features
        let currentPracticeType = '';
        let practiceQuestions = [];
        let currentQuestionIndex = 0;
        let practiceAnswers = [];
        let practiceScore = 0;

        // Article tab switching function
        function switchArticleTab(tab) {
            const manualTab = document.getElementById('articleManualTab');
            const fileTab = document.getElementById('articleFileTab');
            const manualPanel = document.getElementById('articleManualPanel');
            const filePanel = document.getElementById('articleFilePanel');

            if (tab === 'manual') {
                manualTab.className = 'px-3 py-1 bg-primary text-white rounded-md text-sm';
                fileTab.className = 'px-3 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md text-sm';
                manualPanel.classList.remove('hidden');
                filePanel.classList.add('hidden');
            } else {
                fileTab.className = 'px-3 py-1 bg-primary text-white rounded-md text-sm';
                manualTab.className = 'px-3 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md text-sm';
                filePanel.classList.remove('hidden');
                manualPanel.classList.add('hidden');
            }
        }

        // Handle article file upload
        async function handleArticleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const articleProgress = document.getElementById('articleProgress');
            
            articleProgress.classList.remove('hidden');
            
            try {
                let text = '';
                
                if (fileName.endsWith('.txt')) {
                    text = await file.text();
                } else if (fileName.endsWith('.pdf')) {
                    text = await handlePDFExtraction(file);
                } else if (fileName.endsWith('.docx')) {
                    text = await handleDOCXExtraction(file);
                } else {
                    throw new Error('Unsupported file type. Please upload PDF, DOCX, or TXT files.');
                }
                
                // Put the extracted text into the article input
                document.getElementById('articleInput').value = text;
                updateProcessButton();
                
                // Switch back to manual tab to show the text
                switchArticleTab('manual');
                
                articleProgress.classList.add('hidden');
                
            } catch (error) {
                console.error('Error processing article file:', error);
                articleProgress.classList.add('hidden');
                alert(`Error: ${error.message}`);
            }
        }

        // Tab switching function
        function switchTab(tab) {
            if (tab === 'pdf') {
                // Activate PDF tab
                pdfTab.className = 'px-4 py-2 bg-primary text-white rounded-md text-sm';
                manualTab.className = 'px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md text-sm';
                pdfPanel.classList.remove('hidden');
                manualPanel.classList.add('hidden');
            } else {
                // Activate Manual tab
                manualTab.className = 'px-4 py-2 bg-primary text-white rounded-md text-sm';
                pdfTab.className = 'px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md text-sm';
                manualPanel.classList.remove('hidden');
                pdfPanel.classList.add('hidden');
            }
        }

        // Manual text extraction function
        function handleManualExtraction() {
            const text = manualTextInput.value.trim();
            if (!text) {
                alert('Please paste some text from your past paper first.');
                return;
            }
            
            console.log(`Processing manual text input: ${text.length} characters`);
            extractWordsFromText(text);
        }

        // Universal file handler for both PDF and DOCX
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            console.log(`Processing file: ${file.name}, Size: ${fileSize} MB`);
            
            extractionProgress.classList.remove('hidden');
            
            try {
                let fullText = '';
                
                if (fileName.endsWith('.pdf')) {
                    updateProgressMessage('üìÑ Processing PDF file...');
                    fullText = await handlePDFExtraction(file);
                } else if (fileName.endsWith('.docx')) {
                    updateProgressMessage('üìù Processing DOCX file...');
                    fullText = await handleDOCXExtraction(file);
                } else {
                    throw new Error('Unsupported file type. Please upload a PDF or DOCX file.');
                }
                
                extractWordsFromText(fullText);
                extractionProgress.classList.add('hidden');
                
            } catch (error) {
                console.error('Error processing file:', error);
                extractionProgress.classList.add('hidden');
                alert(`Error: ${error.message}`);
            }
        }

        // PDF extraction function
        async function handlePDFExtraction(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({
                data: arrayBuffer,
                cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                cMapPacked: true
            }).promise;
            
            console.log(`PDF loaded successfully. Pages: ${pdf.numPages}`);
            let fullText = '';
            
            // Process pages in chunks to avoid memory issues
            const chunkSize = 5;
            for (let i = 1; i <= pdf.numPages; i += chunkSize) {
                const endPage = Math.min(i + chunkSize - 1, pdf.numPages);
                updateProgressMessage(`üìÑ Processing PDF pages ${i} to ${endPage}...`);
                
                const pagePromises = [];
                for (let pageNum = i; pageNum <= endPage; pageNum++) {
                    pagePromises.push(
                        pdf.getPage(pageNum).then(page => 
                            page.getTextContent().then(textContent => ({
                                pageNum,
                                text: textContent.items.map(item => item.str).join(' ')
                            }))
                        )
                    );
                }
                
                const pageTexts = await Promise.all(pagePromises);
                pageTexts.sort((a, b) => a.pageNum - b.pageNum);
                
                for (const pageData of pageTexts) {
                    fullText += pageData.text + ' ';
                }
                
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            console.log(`Extracted PDF text length: ${fullText.length} characters`);
            
            if (fullText.trim().length === 0) {
                console.log('No text found in PDF, trying OCR...');
                updateProgressMessage('üì∑ Detected scanned PDF - Using OCR to extract text...');
                fullText = await extractTextWithOCR(pdf);
            }
            
            return fullText;
        }

        // DOCX extraction function
        async function handleDOCXExtraction(file) {
            try {
                updateProgressMessage('üìù Reading DOCX file...');
                
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                
                const fullText = result.value;
                console.log(`Extracted DOCX text length: ${fullText.length} characters`);
                
                if (fullText.trim().length === 0) {
                    throw new Error('No text found in the DOCX file. The document may be empty or contain only images.');
                }
                
                updateProgressMessage('‚úÖ DOCX text extracted successfully!');
                return fullText;
                
            } catch (error) {
                console.error('DOCX extraction error:', error);
                throw new Error(`Failed to read DOCX file: ${error.message}. Make sure it's a valid Word document.`);
            }
        }

        function extractWordsFromText(text) {
            const minLength = parseInt(minWordLength.value);
            console.log(`Processing text with ${text.length} characters`);
            
            // Check if NLP library is available with better detection
            let nlpFunction = null;
            if (typeof nlp !== 'undefined') {
                nlpFunction = nlp;
            } else if (typeof window.nlp !== 'undefined') {
                nlpFunction = window.nlp;
            } else if (typeof compromise !== 'undefined') {
                nlpFunction = compromise;
            } else if (typeof window.compromise !== 'undefined') {
                nlpFunction = window.compromise;
            }
            
            if (!nlpFunction) {
                console.log('NLP library not found. Available globals:', Object.keys(window).filter(k => k.includes('nlp') || k.includes('compromise')));
                console.log('Using fallback method...');
                extractWordsWithFallback(text);
                return;
            }
            
            // Use Compromise for part-of-speech analysis
            console.log('Analyzing text with NLP library...');
            console.log('NLP function found:', typeof nlpFunction);
            
            let doc;
            try {
                doc = nlpFunction(text);
                console.log('NLP document created successfully');
            } catch (error) {
                console.error('Error creating NLP document:', error);
                console.log('Falling back to simple extraction...');
                extractWordsWithFallback(text);
                return;
            }
            
            // Extract words with their parts of speech
            const wordsWithPOS = {};
            wordsByPOS = {
                'Nouns': {},
                'Verbs': {},
                'Adjectives': {},
                'Adverbs': {},
                'Other': {}
            };
            
            // Process different parts of speech
            const nouns = doc.nouns().out('array');
            const verbs = doc.verbs().out('array');
            const adjectives = doc.adjectives().out('array');
            const adverbs = doc.adverbs().out('array');
            
            // Helper function to add words to categories
            function addWords(wordArray, category) {
                wordArray.forEach(phrase => {
                    // Split phrases and process individual words
                    const words = phrase.toLowerCase()
                        .replace(/[^\w\s']/g, ' ')
                        .split(/\s+/)
                        .filter(word => {
                            if (!word || word.length < minLength) return false;
                            if (/^\d+$/.test(word)) return false;
                            
                            const stopWords = new Set(['the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'had', 'her', 'was', 'one', 'our', 'out', 'day', 'get', 'has', 'him', 'his', 'how', 'its', 'may', 'new', 'now', 'old', 'see', 'two', 'who', 'boy', 'did', 'she', 'use', 'way', 'say', 'each', 'which', 'their', 'said', 'them', 'they', 'been', 'have', 'there', 'what', 'were', 'will', 'when', 'where', 'with', 'this', 'that', 'from', 'would', 'could', 'should']);
                            if (stopWords.has(word)) return false;
                            
                            return /^[a-z][\w'-]*[a-z]$/.test(word) || /^[a-z]+$/.test(word);
                        })
                        .map(word => word.replace(/'/g, ''));
                    
                    words.forEach(word => {
                        if (!wordsWithPOS[word]) {
                            wordsWithPOS[word] = { freq: 0, pos: category };
                        }
                        wordsWithPOS[word].freq++;
                        
                        if (!wordsByPOS[category][word]) {
                            wordsByPOS[category][word] = 0;
                        }
                        wordsByPOS[category][word]++;
                    });
                });
            }
            
            // Add words by category
            addWords(nouns, 'Nouns');
            addWords(verbs, 'Verbs');
            addWords(adjectives, 'Adjectives');
            addWords(adverbs, 'Adverbs');
            
            // For remaining words that weren't categorized, use simple approach
            const allWords = text.toLowerCase()
                .replace(/[^\w\s']/g, ' ')
                .replace(/\b\d+\b/g, ' ')
                .split(/\s+/)
                .filter(word => {
                    if (!word || word.length < minLength) return false;
                    if (/^\d+$/.test(word)) return false;
                    
                    const stopWords = new Set(['the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'had', 'her', 'was', 'one', 'our', 'out', 'day', 'get', 'has', 'him', 'his', 'how', 'its', 'may', 'new', 'now', 'old', 'see', 'two', 'who', 'boy', 'did', 'she', 'use', 'way', 'say', 'each', 'which', 'their', 'said', 'them', 'they', 'been', 'have', 'there', 'what', 'were', 'will', 'when', 'where', 'with', 'this', 'that', 'from', 'would', 'could', 'should']);
                    if (stopWords.has(word)) return false;
                    
                    return /^[a-z][\w'-]*[a-z]$/.test(word) || /^[a-z]+$/.test(word);
                })
                .map(word => word.replace(/'/g, ''));
            
            // Add uncategorized words to "Other"
            allWords.forEach(word => {
                if (!wordsWithPOS[word]) {
                    wordsWithPOS[word] = { freq: 1, pos: 'Other' };
                    if (!wordsByPOS['Other'][word]) {
                        wordsByPOS['Other'][word] = 0;
                    }
                    wordsByPOS['Other'][word]++;
                }
            });
            
            // Filter by minimum frequency
            const totalUniqueWords = Object.keys(wordsWithPOS).length;
            const minFreq = totalUniqueWords > 100 ? 2 : 1;
            
            // Create global sets for compatibility
            extractedWords = new Set();
            wordFrequency = {};
            
            Object.entries(wordsWithPOS).forEach(([word, data]) => {
                if (data.freq >= minFreq) {
                    extractedWords.add(word);
                    wordFrequency[word] = data.freq;
                }
            });
            
            console.log(`Final word list: ${extractedWords.size} words`);
            console.log('Words by POS:', Object.keys(wordsByPOS).map(pos => `${pos}: ${Object.keys(wordsByPOS[pos]).length}`));
            
            displayWordListByPOS();
            updateProcessButton();
        }

        // Fallback function with smart categorization
        function extractWordsWithFallback(text) {
            const minLength = parseInt(minWordLength.value);
            console.log('Using fallback word extraction with smart categorization...');
            
            // Initialize structure
            wordsByPOS = {
                'Nouns': {},
                'Verbs': {},
                'Adjectives': {},
                'Adverbs': {},
                'Other': {}
            };
            
            // Simple word extraction
            const words = text.toLowerCase()
                .replace(/[^\w\s']/g, ' ')
                .replace(/\b\d+\b/g, ' ')
                .split(/\s+/)
                .filter(word => {
                    if (!word || word.length < minLength) return false;
                    if (/^\d+$/.test(word)) return false;
                    
                    const stopWords = new Set(['the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'had', 'her', 'was', 'one', 'our', 'out', 'day', 'get', 'has', 'him', 'his', 'how', 'its', 'may', 'new', 'now', 'old', 'see', 'two', 'who', 'boy', 'did', 'she', 'use', 'way', 'say', 'each', 'which', 'their', 'said', 'them', 'they', 'been', 'have', 'there', 'what', 'were', 'will', 'when', 'where', 'with', 'this', 'that', 'from', 'would', 'could', 'should']);
                    if (stopWords.has(word)) return false;
                    
                    return /^[a-z][\w'-]*[a-z]$/.test(word) || /^[a-z]+$/.test(word);
                })
                .map(word => word.replace(/'/g, ''));
            
            // Count frequency
            const frequency = {};
            words.forEach(word => {
                frequency[word] = (frequency[word] || 0) + 1;
            });
            
            // Filter by minimum frequency
            const totalUniqueWords = Object.keys(frequency).length;
            const minFreq = totalUniqueWords > 100 ? 2 : 1;
            
            // Smart categorization based on word patterns and known word lists
            Object.entries(frequency).forEach(([word, freq]) => {
                if (freq >= minFreq) {
                    const category = categorizeWordSmart(word);
                    wordsByPOS[category][word] = freq;
                }
            });
            
            // Create global sets for compatibility
            extractedWords = new Set();
            wordFrequency = {};
            
            Object.entries(frequency).forEach(([word, freq]) => {
                if (freq >= minFreq) {
                    extractedWords.add(word);
                    wordFrequency[word] = freq;
                }
            });
            
            const totalCategorized = Object.values(wordsByPOS).reduce((sum, cat) => sum + Object.keys(cat).length, 0);
            console.log(`Smart fallback extraction complete: ${extractedWords.size} words`);
            console.log('Word distribution:', Object.entries(wordsByPOS).map(([pos, words]) => `${pos}: ${Object.keys(words).length}`).join(', '));
            
            displayWordListByPOS();
            updateProcessButton();
        }
        
        // Smart word categorization function
        function categorizeWordSmart(word) {
            // Noun patterns and common nouns
            const nounPatterns = [
                /tion$/, /sion$/, /ment$/, /ness$/, /ity$/, /ty$/, /ency$/, /ance$/, /ence$/,
                /ism$/, /ist$/, /er$/, /or$/, /ure$/, /ware$/, /ship$/, /hood$/, /dom$/
            ];
            
            const commonNouns = new Set([
                'system', 'method', 'approach', 'process', 'structure', 'framework', 'concept',
                'principle', 'theory', 'analysis', 'research', 'study', 'investigation', 'examination',
                'development', 'management', 'organization', 'institution', 'establishment',
                'community', 'society', 'population', 'individual', 'person', 'people',
                'environment', 'situation', 'condition', 'circumstance', 'context',
                'problem', 'issue', 'challenge', 'difficulty', 'solution', 'response',
                'information', 'knowledge', 'understanding', 'awareness', 'experience',
                'education', 'learning', 'training', 'instruction', 'teaching',
                'technology', 'science', 'research', 'innovation', 'progress',
                'economy', 'business', 'industry', 'market', 'finance',
                'culture', 'tradition', 'custom', 'practice', 'behavior',
                'health', 'medicine', 'treatment', 'therapy', 'care',
                'government', 'policy', 'regulation', 'administration', 'authority',
                'relationship', 'connection', 'association', 'partnership', 'cooperation'
            ]);
            
            // Verb patterns and common verbs
            const verbPatterns = [
                /ize$/, /ise$/, /ify$/, /ate$/, /en$/, /ing$/, /ed$/
            ];
            
            const commonVerbs = new Set([
                'establish', 'develop', 'create', 'generate', 'produce', 'construct', 'build',
                'implement', 'execute', 'perform', 'conduct', 'operate', 'function',
                'analyze', 'examine', 'investigate', 'explore', 'discover', 'identify',
                'demonstrate', 'illustrate', 'indicate', 'show', 'reveal', 'display',
                'provide', 'supply', 'offer', 'deliver', 'present', 'contribute',
                'maintain', 'preserve', 'sustain', 'support', 'enhance', 'improve',
                'facilitate', 'enable', 'promote', 'encourage', 'stimulate',
                'utilize', 'employ', 'apply', 'adopt', 'incorporate', 'integrate',
                'communicate', 'express', 'convey', 'transmit', 'exchange',
                'participate', 'engage', 'involve', 'collaborate', 'cooperate',
                'achieve', 'accomplish', 'succeed', 'complete', 'finish',
                'require', 'demand', 'necessitate', 'involve', 'include',
                'influence', 'affect', 'impact', 'determine', 'control',
                'consider', 'evaluate', 'assess', 'judge', 'determine',
                'represent', 'constitute', 'comprise', 'contain', 'involve'
            ]);
            
            // Adjective patterns and common adjectives
            const adjectivePatterns = [
                /ful$/, /less$/, /ous$/, /eous$/, /ious$/, /ive$/, /ative$/, /able$/, /ible$/,
                /ic$/, /ical$/, /al$/, /ial$/, /ary$/, /ory$/, /ant$/, /ent$/
            ];
            
            const commonAdjectives = new Set([
                'important', 'significant', 'essential', 'crucial', 'vital', 'critical',
                'effective', 'successful', 'beneficial', 'valuable', 'useful', 'practical',
                'appropriate', 'suitable', 'relevant', 'applicable', 'related',
                'comprehensive', 'extensive', 'complete', 'thorough', 'detailed',
                'complex', 'complicated', 'sophisticated', 'advanced', 'technical',
                'simple', 'basic', 'fundamental', 'elementary', 'primary',
                'available', 'accessible', 'obtainable', 'possible', 'potential',
                'necessary', 'required', 'mandatory', 'obligatory', 'compulsory',
                'similar', 'comparable', 'equivalent', 'identical', 'same',
                'different', 'distinct', 'separate', 'alternative', 'various',
                'specific', 'particular', 'individual', 'personal', 'unique',
                'general', 'common', 'universal', 'widespread', 'typical',
                'positive', 'negative', 'neutral', 'favorable', 'beneficial',
                'professional', 'academic', 'educational', 'scientific', 'technical',
                'social', 'cultural', 'economic', 'political', 'environmental',
                'modern', 'contemporary', 'current', 'recent', 'latest',
                'traditional', 'conventional', 'standard', 'normal', 'regular'
            ]);
            
            // Adverb patterns and common adverbs
            const adverbPatterns = [/ly$/];
            
            const commonAdverbs = new Set([
                'effectively', 'successfully', 'efficiently', 'properly', 'appropriately',
                'significantly', 'considerably', 'substantially', 'particularly', 'especially',
                'generally', 'typically', 'usually', 'normally', 'commonly',
                'specifically', 'particularly', 'precisely', 'exactly', 'accurately',
                'completely', 'entirely', 'totally', 'fully', 'thoroughly',
                'clearly', 'obviously', 'evidently', 'apparently', 'definitely',
                'potentially', 'possibly', 'probably', 'likely', 'certainly',
                'directly', 'indirectly', 'immediately', 'gradually', 'rapidly',
                'carefully', 'deliberately', 'systematically', 'methodically',
                'actively', 'passively', 'automatically', 'manually', 'voluntarily'
            ]);
            
            // Check known word lists first (most reliable)
            if (commonNouns.has(word)) return 'Nouns';
            if (commonVerbs.has(word)) return 'Verbs';
            if (commonAdjectives.has(word)) return 'Adjectives';
            if (commonAdverbs.has(word)) return 'Adverbs';
            
            // Check patterns
            if (nounPatterns.some(pattern => pattern.test(word))) return 'Nouns';
            if (verbPatterns.some(pattern => pattern.test(word))) return 'Verbs';
            if (adjectivePatterns.some(pattern => pattern.test(word))) return 'Adjectives';
            if (adverbPatterns.some(pattern => pattern.test(word))) return 'Adverbs';
            
            // Additional heuristics based on word structure
            if (word.endsWith('ing') || word.endsWith('ed')) {
                // Could be verb forms, but check if it's a gerund (noun)
                if (word.length > 6 && !commonVerbs.has(word.replace(/ing$/, ''))) {
                    return 'Nouns'; // Likely a gerund used as noun
                }
                return 'Verbs';
            }
            
            // Check if it starts with capital (might be proper noun - academic context)
            if (/^[A-Z]/.test(word) && word.length > 4) {
                return 'Nouns';
            }
            
            // Default fallback based on common academic patterns
            if (word.length >= 8) {
                // Longer words in academic text are often nouns or adjectives
                return Math.random() > 0.5 ? 'Nouns' : 'Adjectives';
            } else if (word.length <= 4) {
                // Shorter words often function words or simple verbs
                return 'Other';
            }
            
            // For remaining words, distribute more intelligently
            const firstLetter = word[0];
            if ('aeiou'.includes(firstLetter)) {
                return 'Adjectives'; // Many adjectives start with vowels
            } else if ('bcdfg'.includes(firstLetter)) {
                return 'Nouns'; // Many nouns start with these consonants
            } else {
                return 'Verbs'; // Remaining words more likely to be verbs
            }
        }

        function displayWordListByPOS() {
            if (extractedWords.size === 0) {
                wordList.innerHTML = '<p class="text-gray-500 text-center py-8">No words found. Try a different PDF or adjust the minimum word length.</p>';
                wordCount.textContent = '0 words';
                document.getElementById('exportOptions').classList.add('hidden');
                return;
            }

            // Count total words
            const totalWords = extractedWords.size;
            
            // Create HTML organized by part of speech
            let html = '';
            const posColors = {
                'Nouns': 'bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200',
                'Verbs': 'bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200',
                'Adjectives': 'bg-purple-100 dark:bg-purple-800 text-purple-800 dark:text-purple-200',
                'Adverbs': 'bg-orange-100 dark:bg-orange-800 text-orange-800 dark:text-orange-200',
                'Other': 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
            };
            
            Object.entries(wordsByPOS).forEach(([pos, words]) => {
                const wordCount = Object.keys(words).length;
                if (wordCount > 0) {
                    html += `<div class="mb-4">
                        <h3 class="text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">
                            ${pos} (${wordCount} words)
                        </h3>
                        <div class="space-y-1">`;
                    
                    // Sort words within each POS category
                    const sortedWords = Object.entries(words).sort((a, b) => b[1] - a[1]);
                    
                    sortedWords.forEach(([word, freq]) => {
                        html += `<span class="inline-block ${posColors[pos]} px-2 py-1 rounded-md text-sm mr-2 mb-1">
                            ${word} <span class="text-xs opacity-70">(${freq})</span>
                        </span>`;
                    });
                    
                    html += `</div></div>`;
                }
            });
            
            wordList.innerHTML = html;
            wordCount.textContent = `${totalWords} words`;
            document.getElementById('exportOptions').classList.remove('hidden');
            
            // Add export event listeners
            setupExportListeners();
        }
        
        // Keep the old function for compatibility
        function displayWordList(sortedWords) {
            displayWordListByPOS();
        }

        function clearWordList() {
            extractedWords.clear();
            wordFrequency = {};
            wordList.innerHTML = '<p class="text-gray-500 text-center py-8">Upload a PDF to extract vocabulary words</p>';
            wordCount.textContent = '0 words';
            document.getElementById('exportOptions').classList.add('hidden');
            updateProcessButton();
        }

        // Export functionality
        function setupExportListeners() {
            // Remove existing listeners to prevent duplicates
            const exportPDF = document.getElementById('exportPDF');
            const exportDOCX = document.getElementById('exportDOCX');
            const sortOption = document.getElementById('sortOption');
            
            exportPDF.replaceWith(exportPDF.cloneNode(true));
            exportDOCX.replaceWith(exportDOCX.cloneNode(true));
            
            // Add new listeners
            document.getElementById('exportPDF').addEventListener('click', () => exportWordList('pdf'));
            document.getElementById('exportDOCX').addEventListener('click', () => exportWordList('docx'));
            document.getElementById('sortOption').addEventListener('change', updateWordListDisplay);
        }

        function updateWordListDisplay() {
            const sortOption = document.getElementById('sortOption').value;
            const sortedWords = getSortedWords(sortOption);
            
            // Update display without changing export options visibility
            const wordsHTML = sortedWords.map(({word, freq}) => 
                `<span class="inline-block bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-md text-sm mr-2 mb-2">
                    ${word} <span class="text-xs opacity-70">(${freq})</span>
                </span>`
            ).join('');
            
            wordList.innerHTML = wordsHTML;
        }

        function getSortedWords(sortType = 'frequency') {
            const wordsArray = Array.from(extractedWords).map(word => ({
                word,
                freq: wordFrequency[word] || 1
            }));

            switch (sortType) {
                case 'alphabetical':
                    return wordsArray.sort((a, b) => a.word.localeCompare(b.word));
                case 'length':
                    return wordsArray.sort((a, b) => b.word.length - a.word.length || a.word.localeCompare(b.word));
                case 'frequency':
                default:
                    return wordsArray.sort((a, b) => b.freq - a.freq || a.word.localeCompare(b.word));
            }
        }

        function exportWordList(format) {
            if (extractedWords.size === 0) {
                alert('No words to export. Please extract words first.');
                return;
            }

            const sortOption = document.getElementById('sortOption').value;
            const sortedWords = getSortedWords(sortOption);
            const currentDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
            const fileName = `Vocabulary_List_${currentDate}`;

            if (format === 'pdf') {
                exportToPDF(sortedWords, fileName);
            } else if (format === 'docx') {
                exportToDOCX(sortedWords, fileName);
            }
        }

        function exportToPDF(words, fileName) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Title
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Vocabulary Word List', 105, 25, { align: 'center' });

                // Subtitle
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                const sortType = document.getElementById('sortOption').value;
                const subtitle = `Generated on ${new Date().toLocaleDateString()} | Sorted by ${sortType.charAt(0).toUpperCase() + sortType.slice(1)}`;
                doc.text(subtitle, 105, 35, { align: 'center' });

                // Word count
                doc.text(`Total words: ${words.length}`, 105, 45, { align: 'center' });

                // Line separator
                doc.line(20, 50, 190, 50);

                // Organize words by part of speech for export
                const wordsWithPOS = [];
                Object.entries(wordsByPOS).forEach(([pos, posWords]) => {
                    Object.entries(posWords).forEach(([word, freq]) => {
                        wordsWithPOS.push({ word, freq, pos });
                    });
                });

                // Sort according to user selection
                const sortOption = document.getElementById('sortOption').value;
                if (sortOption === 'alphabetical') {
                    wordsWithPOS.sort((a, b) => a.word.localeCompare(b.word));
                } else if (sortOption === 'length') {
                    wordsWithPOS.sort((a, b) => b.word.length - a.word.length || a.word.localeCompare(b.word));
                } else {
                    wordsWithPOS.sort((a, b) => b.freq - a.freq || a.word.localeCompare(b.word));
                }

                // Table headers with POS column
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('#', 22, 60);
                doc.text('Word', 30, 60);
                doc.text('POS', 75, 60);
                doc.text('Freq', 90, 60);
                doc.text('#', 107, 60);
                doc.text('Word', 115, 60);
                doc.text('POS', 160, 60);
                doc.text('Freq', 175, 60);

                // Header underlines
                doc.line(20, 63, 100, 63);  // Left column
                doc.line(105, 63, 185, 63); // Right column

                // Words table with POS
                let yPosition = 70;
                const lineHeight = 5;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);

                for (let i = 0; i < wordsWithPOS.length; i += 2) {
                    // Check if we need a new page
                    if (yPosition > 275) {
                        doc.addPage();
                        yPosition = 25;
                        
                        // Repeat headers on new page
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(9);
                        doc.text('#', 22, yPosition);
                        doc.text('Word', 30, yPosition);
                        doc.text('POS', 75, yPosition);
                        doc.text('Freq', 90, yPosition);
                        doc.text('#', 107, yPosition);
                        doc.text('Word', 115, yPosition);
                        doc.text('POS', 160, yPosition);
                        doc.text('Freq', 175, yPosition);
                        doc.line(20, yPosition + 3, 100, yPosition + 3);
                        doc.line(105, yPosition + 3, 185, yPosition + 3);
                        yPosition += 10;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(8);
                    }

                    // Left column
                    const leftItem = wordsWithPOS[i];
                    const leftNumber = (i + 1).toString();
                    const leftWord = leftItem.word.length > 20 ? leftItem.word.substring(0, 17) + '...' : leftItem.word;
                    const leftPOS = leftItem.pos.substr(0, 4); // Abbreviate POS
                    const leftFreq = `(${leftItem.freq})`;

                    doc.text(leftNumber, 22, yPosition);
                    doc.text(leftWord, 30, yPosition);
                    doc.text(leftPOS, 75, yPosition);
                    doc.text(leftFreq, 90, yPosition);

                    // Right column (if exists)
                    if (i + 1 < wordsWithPOS.length) {
                        const rightItem = wordsWithPOS[i + 1];
                        const rightNumber = (i + 2).toString();
                        const rightWord = rightItem.word.length > 20 ? rightItem.word.substring(0, 17) + '...' : rightItem.word;
                        const rightPOS = rightItem.pos.substr(0, 4);
                        const rightFreq = `(${rightItem.freq})`;

                        doc.text(rightNumber, 107, yPosition);
                        doc.text(rightWord, 115, yPosition);
                        doc.text(rightPOS, 160, yPosition);
                        doc.text(rightFreq, 175, yPosition);
                    }

                    yPosition += lineHeight;
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text('Generated by Vocabulary Builder App', 105, 295, { align: 'center' });
                }

                // Save the PDF
                doc.save(`${fileName}.pdf`);
                
                // Update button temporarily
                const button = document.getElementById('exportPDF');
                const originalText = button.textContent;
                button.textContent = '‚úÖ PDF Downloaded!';
                button.classList.add('bg-green-600');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);

            } catch (error) {
                console.error('PDF export error:', error);
                alert('Error exporting PDF. Please try again.');
            }
        }

        function exportToDOCX(words, fileName) {
            try {
                // Create a simple text file for download since docx library might have issues
                let content = `VOCABULARY WORD LIST\n`;
                content += `===================\n\n`;
                content += `Generated on: ${new Date().toLocaleDateString()}\n`;
                content += `Sort order: ${document.getElementById('sortOption').value}\n`;
                content += `Total words: ${words.length}\n\n`;
                
                words.forEach((item, index) => {
                    content += `${index + 1}. ${item.word} (appears ${item.freq} times)\n`;
                });

                // Create and download the file
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${fileName}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                // Update button temporarily
                const button = document.getElementById('exportDOCX');
                const originalText = button.textContent;
                button.textContent = '‚úÖ File Downloaded!';
                button.classList.add('bg-green-600');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);

            } catch (error) {
                console.error('DOCX export error:', error);
                alert('Error exporting file. Please try again.');
            }
        }

        function updateProcessButton() {
            const hasWords = extractedWords.size > 0;
            const hasText = articleInput.value.trim().length > 0;
            processArticle.disabled = !hasWords || !hasText;
        }

        function transformArticle() {
            const text = articleInput.value.trim();
            if (!text || extractedWords.size === 0) return;

            const preserveProperNouns = document.getElementById('preserveProperNouns').checked;
            const highlightChanges = document.getElementById('highlightChanges').checked;
            
            console.log('Starting balanced article transformation...');
            
            let replacements = 0;
            
            // Create enhanced mappings with more coverage but still intelligent
            const enhancedMappings = createEnhancedMappings();
            console.log(`Created ${Object.keys(enhancedMappings).length} enhanced mappings`);
            
            // Split text into sentences to maintain context
            const sentences = text.split(/([.!?]+\s*)/);
            
            const transformedSentences = sentences.map(sentence => {
                if (!sentence.trim() || /^[.!?]+\s*$/.test(sentence)) {
                    return sentence; // Keep punctuation as is
                }
                
                // Split sentence into words while preserving punctuation and spacing
                const words = sentence.split(/(\s+|[.,!?;:"'()[\]{}])/);
                
                const transformedWords = words.map((word, index) => {
                    const cleanWord = word.toLowerCase().replace(/[^\w]/g, '');
                    
                    // Skip if it's not a word, too short, or a proper noun (if preserving)
                    if (!cleanWord || cleanWord.length < 4) return word;
                    if (preserveProperNouns && /^[A-Z]/.test(word)) return word;
                    
                    // Skip only absolutely essential structural words
                    const essentialWords = new Set([
                        // Core grammar - only the most essential
                        'the', 'and', 'or', 'but', 'if', 'when', 'where', 'who', 'what', 'how', 'why', 
                        'because', 'although', 'while', 'since', 'before', 'after', 'during', 'between',
                        
                        // Core auxiliary verbs - essential for tense
                        'will', 'would', 'could', 'should', 'must', 'might', 'can', 'been', 'being',
                        
                        // Core pronouns - essential for reference
                        'this', 'that', 'these', 'those', 'they', 'them', 'their', 'there', 'here'
                    ]);
                    
                    if (essentialWords.has(cleanWord)) return word;
                    
                    // Enhanced replacement logic with better coverage
                    if (enhancedMappings[cleanWord]) {
                        const replacement = enhancedMappings[cleanWord];
                        
                        // Context check for critical phrase preservation
                        const nextWord = words[index + 2] ? words[index + 2].toLowerCase().replace(/[^\w]/g, '') : '';
                        
                        // Skip replacement for specific fixed phrases
                        if ((cleanWord === 'make' && nextWord === 'sure') ||
                            (cleanWord === 'take' && (nextWord === 'place' || nextWord === 'time')) ||
                            (cleanWord === 'come' && nextWord === 'back')) {
                            return word;
                        }
                        
                        replacements++;
                        
                        // Preserve original capitalization
                        let finalReplacement;
                        if (word[0] === word[0].toUpperCase()) {
                            finalReplacement = replacement.charAt(0).toUpperCase() + replacement.slice(1);
                        } else {
                            finalReplacement = replacement;
                        }
                        
                        console.log(`Enhanced replacement: ${cleanWord} ‚Üí ${replacement}`);
                        
                        if (highlightChanges) {
                            return `<span class="word-highlight">${finalReplacement}</span>`;
                        } else {
                            return finalReplacement;
                        }
                    }
                    
                    return word;
                });
                
                return transformedWords.join('');
            });
            
            const transformedText = transformedSentences.join('');
            
            console.log(`Enhanced transformation complete: ${replacements} words replaced with balanced approach`);
            
            // Display results
            processedArticle.innerHTML = transformedText;
            replacementCount.textContent = replacements;
            replacementStats.classList.remove('hidden');
            copyToClipboard.classList.remove('hidden');
        }

        function createComprehensiveMappings() {
            // Create comprehensive mappings by using ALL vocabulary words
            const mappings = {};
            const vocabularyArray = Array.from(extractedWords);
            
            console.log(`Creating comprehensive mappings from ${vocabularyArray.length} vocabulary words...`);
            
            // Start with the simple->academic mappings
            const baseMappings = createWordMappings();
            Object.assign(mappings, baseMappings);
            
            // Now create more extensive mappings using semantic similarity
            const commonWords = [
                // Common verbs to replace
                'said', 'says', 'went', 'came', 'got', 'put', 'took', 'made', 'did', 'had', 'was', 'were', 'are', 'is', 'be', 'been', 'have', 'has', 'do', 'does', 'go', 'goes', 'come', 'comes', 'see', 'saw', 'seen', 'look', 'looked', 'give', 'gave', 'given', 'take', 'took', 'taken', 'know', 'knew', 'known', 'think', 'thought', 'want', 'wanted', 'like', 'liked', 'work', 'worked', 'live', 'lived', 'call', 'called', 'ask', 'asked', 'try', 'tried', 'feel', 'felt', 'leave', 'left', 'move', 'moved', 'play', 'played', 'run', 'ran', 'walk', 'walked', 'talk', 'talked', 'turn', 'turned', 'start', 'started', 'show', 'showed', 'hear', 'heard', 'let', 'write', 'wrote', 'written', 'sit', 'sat', 'stand', 'stood', 'lose', 'lost', 'pay', 'paid', 'meet', 'met', 'include', 'included', 'continue', 'continued', 'set', 'bring', 'brought', 'happen', 'happened', 'begin', 'began', 'begun', 'keep', 'kept', 'hold', 'held', 'tell', 'told', 'follow', 'followed', 'stay', 'stayed', 'stop', 'stopped', 'create', 'created', 'speak', 'spoke', 'spoken', 'read', 'lead', 'led', 'understand', 'understood', 'watch', 'watched', 'build', 'built', 'spend', 'spent', 'cut', 'buy', 'bought', 'finish', 'finished', 'join', 'joined', 'hope', 'hoped', 'develop', 'developed', 'talk', 'talked', 'open', 'opened', 'win', 'won', 'offer', 'offered', 'remember', 'remembered', 'consider', 'considered', 'appear', 'appeared', 'actually', 'really', 'probably', 'certainly', 'particularly', 'especially', 'quite', 'rather', 'very', 'too', 'so', 'such', 'more', 'most', 'much', 'many', 'few', 'little', 'less', 'least', 'enough', 'several', 'both', 'either', 'neither',
                
                // Common nouns to replace
                'people', 'person', 'man', 'woman', 'child', 'children', 'family', 'friend', 'friends', 'group', 'company', 'business', 'job', 'work', 'money', 'time', 'year', 'years', 'day', 'days', 'week', 'weeks', 'month', 'months', 'hour', 'hours', 'minute', 'minutes', 'moment', 'place', 'places', 'home', 'house', 'room', 'area', 'city', 'country', 'world', 'state', 'government', 'school', 'student', 'students', 'teacher', 'teachers', 'book', 'books', 'story', 'stories', 'idea', 'ideas', 'problem', 'problems', 'question', 'questions', 'answer', 'answers', 'result', 'results', 'change', 'changes', 'fact', 'facts', 'information', 'news', 'report', 'reports', 'study', 'studies', 'research', 'data', 'number', 'numbers', 'point', 'points', 'part', 'parts', 'way', 'ways', 'example', 'examples', 'case', 'cases', 'reason', 'reasons', 'system', 'systems', 'program', 'programs', 'service', 'services', 'product', 'products', 'technology', 'computer', 'computers', 'internet', 'phone', 'phones', 'car', 'cars', 'water', 'food', 'health', 'care', 'life', 'death', 'power', 'energy', 'market', 'markets', 'price', 'prices', 'cost', 'costs', 'value', 'values', 'quality', 'control', 'management', 'policy', 'policies', 'law', 'laws', 'rule', 'rules', 'order', 'decision', 'decisions', 'action', 'actions', 'activity', 'activities', 'event', 'events', 'meeting', 'meetings', 'party', 'parties', 'game', 'games', 'sport', 'sports', 'music', 'art', 'culture', 'history', 'future', 'past', 'present', 'war', 'peace', 'love', 'relationship', 'relationships', 'community', 'society', 'public', 'private', 'personal', 'social', 'economic', 'political', 'local', 'national', 'international', 'global', 'human', 'natural', 'environmental', 'medical', 'financial', 'educational', 'professional', 'physical', 'mental', 'emotional', 'spiritual', 'cultural', 'traditional', 'modern', 'current', 'recent', 'old', 'new', 'young', 'adult', 'senior',
                
                // Common adjectives to replace
                'good', 'bad', 'great', 'small', 'big', 'large', 'little', 'long', 'short', 'high', 'low', 'right', 'wrong', 'important', 'special', 'certain', 'possible', 'real', 'true', 'false', 'clear', 'hard', 'easy', 'strong', 'weak', 'free', 'full', 'empty', 'open', 'closed', 'hot', 'cold', 'warm', 'cool', 'fast', 'slow', 'quick', 'early', 'late', 'ready', 'sure', 'happy', 'sad', 'angry', 'afraid', 'surprised', 'excited', 'tired', 'busy', 'free', 'safe', 'dangerous', 'healthy', 'sick', 'rich', 'poor', 'expensive', 'cheap', 'beautiful', 'ugly', 'nice', 'wonderful', 'terrible', 'awful', 'amazing', 'interesting', 'boring', 'funny', 'serious', 'simple', 'complex', 'difficult', 'popular', 'famous', 'successful', 'effective', 'useful', 'helpful', 'necessary', 'available', 'similar', 'different', 'same', 'various', 'general', 'specific', 'particular', 'main', 'major', 'minor', 'basic', 'advanced', 'professional', 'personal', 'social', 'political', 'economic', 'financial', 'legal', 'medical', 'educational', 'environmental', 'technical', 'scientific', 'historical', 'cultural', 'religious', 'military', 'commercial', 'industrial', 'agricultural', 'urban', 'rural', 'domestic', 'foreign', 'international', 'national', 'local', 'regional', 'global', 'worldwide', 'universal', 'common', 'rare', 'unique', 'typical', 'normal', 'unusual', 'strange', 'weird', 'ordinary', 'extraordinary', 'regular', 'irregular', 'standard', 'official', 'formal', 'informal', 'casual', 'serious', 'light', 'heavy', 'thick', 'thin', 'wide', 'narrow', 'deep', 'shallow', 'bright', 'dark', 'loud', 'quiet', 'soft', 'rough', 'smooth', 'sharp', 'dull', 'fresh', 'old', 'clean', 'dirty', 'dry', 'wet', 'solid', 'liquid', 'positive', 'negative', 'active', 'passive', 'direct', 'indirect', 'public', 'private', 'secret', 'obvious', 'hidden', 'visible', 'invisible', 'clear', 'unclear', 'known', 'unknown', 'familiar', 'unfamiliar', 'friendly', 'unfriendly', 'kind', 'cruel', 'gentle', 'violent', 'peaceful', 'aggressive', 'calm', 'nervous', 'relaxed', 'stressed', 'comfortable', 'uncomfortable'
            ];
            
            // Try to map common words to vocabulary words
            commonWords.forEach(commonWord => {
                if (!mappings[commonWord]) {
                    // Find vocabulary words that could replace this common word
                    const candidates = vocabularyArray.filter(vocabWord => {
                        // Skip if it's the same word
                        if (vocabWord === commonWord) return false;
                        
                        // Look for words that are longer and potentially more academic
                        if (vocabWord.length > commonWord.length + 1) {
                            // Check if they share some letters or patterns
                            const commonChars = commonWord.split('').filter(char => vocabWord.includes(char)).length;
                            return commonChars >= Math.min(3, commonWord.length - 1);
                        }
                        
                        return false;
                    });
                    
                    if (candidates.length > 0) {
                        // Sort by frequency and pick the most common vocabulary word
                        candidates.sort((a, b) => (wordFrequency[b] || 0) - (wordFrequency[a] || 0));
                        mappings[commonWord] = candidates[0];
                        console.log(`Common word mapping: ${commonWord} ‚Üí ${candidates[0]}`);
                    }
                }
            });
            
            // Add some random mappings for variety
            const remainingVocab = vocabularyArray.filter(word => !Object.values(mappings).includes(word));
            const unmappedCommon = commonWords.filter(word => !mappings[word]);
            
            // Randomly assign some remaining vocab to unmapped common words
            for (let i = 0; i < Math.min(remainingVocab.length, unmappedCommon.length); i++) {
                const randomVocab = remainingVocab[Math.floor(Math.random() * remainingVocab.length)];
                const randomCommon = unmappedCommon[Math.floor(Math.random() * unmappedCommon.length)];
                
                if (!mappings[randomCommon]) {
                    mappings[randomCommon] = randomVocab;
                    console.log(`Random mapping: ${randomCommon} ‚Üí ${randomVocab}`);
                    
                    // Remove from available lists
                    remainingVocab.splice(remainingVocab.indexOf(randomVocab), 1);
                    unmappedCommon.splice(unmappedCommon.indexOf(randomCommon), 1);
                }
            }
            
            console.log(`Total comprehensive mappings created: ${Object.keys(mappings).length}`);
            return mappings;
        }

        function createWordMappings() {
            // Create mappings from simple words to more academic vocabulary
            const mappings = {};
            const vocabularyArray = Array.from(extractedWords);
            
            console.log(`Creating word mappings from ${vocabularyArray.length} vocabulary words...`);
            
            // Expanded common word replacements (simple -> academic)
            const commonMappings = {
                // Size/Scale
                'big': ['substantial', 'significant', 'considerable', 'extensive', 'major', 'large'],
                'small': ['minimal', 'limited', 'marginal', 'minor', 'slight', 'insignificant'],
                'huge': ['enormous', 'substantial', 'significant', 'considerable', 'extensive'],
                'tiny': ['minimal', 'minute', 'negligible', 'marginal'],
                
                // Quality/Evaluation
                'good': ['effective', 'beneficial', 'advantageous', 'positive', 'successful', 'excellent'],
                'bad': ['detrimental', 'adverse', 'problematic', 'negative', 'harmful', 'unfavorable'],
                'great': ['excellent', 'outstanding', 'remarkable', 'exceptional', 'significant'],
                'nice': ['pleasant', 'agreeable', 'satisfactory', 'appropriate'],
                'awful': ['terrible', 'dreadful', 'problematic', 'concerning'],
                
                // Importance
                'important': ['crucial', 'essential', 'fundamental', 'vital', 'significant', 'critical'],
                'main': ['primary', 'principal', 'fundamental', 'central', 'key'],
                'key': ['essential', 'crucial', 'fundamental', 'vital', 'critical'],
                
                // Actions/Verbs
                'show': ['demonstrate', 'illustrate', 'indicate', 'reveal', 'display', 'exhibit'],
                'make': ['create', 'establish', 'generate', 'produce', 'construct', 'develop'],
                'use': ['utilize', 'employ', 'implement', 'apply', 'adopt'],
                'think': ['consider', 'contemplate', 'analyze', 'examine', 'evaluate'],
                'help': ['facilitate', 'assist', 'support', 'enable', 'contribute'],
                'change': ['modify', 'alter', 'transform', 'adjust', 'adapt'],
                'get': ['obtain', 'acquire', 'secure', 'achieve', 'attain'],
                'start': ['commence', 'initiate', 'establish', 'begin', 'introduce'],
                'end': ['conclude', 'terminate', 'finalize', 'complete'],
                'find': ['discover', 'identify', 'locate', 'determine', 'establish'],
                'tell': ['inform', 'communicate', 'convey', 'explain', 'describe'],
                'ask': ['inquire', 'request', 'solicit', 'question'],
                'try': ['attempt', 'endeavor', 'strive', 'seek'],
                'want': ['desire', 'require', 'seek', 'wish'],
                'need': ['require', 'necessitate', 'demand'],
                'give': ['provide', 'supply', 'offer', 'present'],
                'take': ['acquire', 'obtain', 'receive', 'accept'],
                'put': ['place', 'position', 'locate', 'establish'],
                'keep': ['maintain', 'preserve', 'retain', 'sustain'],
                'come': ['arrive', 'approach', 'emerge'],
                'look': ['examine', 'observe', 'investigate', 'analyze'],
                'work': ['function', 'operate', 'perform'],
                'happen': ['occur', 'transpire', 'emerge'],
                'seem': ['appear', 'suggest', 'indicate'],
                'feel': ['experience', 'perceive', 'sense'],
                'become': ['transform', 'develop', 'evolve'],
                'turn': ['transform', 'convert', 'change'],
                'move': ['progress', 'advance', 'proceed'],
                'run': ['operate', 'function', 'manage'],
                'live': ['exist', 'reside', 'survive'],
                'bring': ['introduce', 'present', 'contribute'],
                'build': ['construct', 'develop', 'establish'],
                'grow': ['develop', 'expand', 'increase'],
                'open': ['accessible', 'available', 'transparent'],
                'close': ['conclude', 'terminate', 'complete'],
                'cut': ['reduce', 'eliminate', 'decrease'],
                'break': ['interrupt', 'discontinue', 'separate'],
                'stop': ['cease', 'terminate', 'discontinue'],
                'play': ['participate', 'engage', 'perform'],
                'study': ['examine', 'analyze', 'investigate'],
                'learn': ['acquire', 'understand', 'comprehend'],
                'teach': ['educate', 'instruct', 'demonstrate'],
                'read': ['examine', 'analyze', 'review'],
                'write': ['compose', 'document', 'record'],
                'speak': ['communicate', 'express', 'articulate'],
                'listen': ['attend', 'concentrate', 'focus'],
                'understand': ['comprehend', 'grasp', 'recognize'],
                'know': ['recognize', 'understand', 'comprehend'],
                'believe': ['consider', 'maintain', 'assume'],
                'remember': ['recall', 'recollect', 'retain'],
                'forget': ['overlook', 'neglect', 'omit'],
                'choose': ['select', 'decide', 'determine'],
                'decide': ['determine', 'conclude', 'resolve'],
                'plan': ['organize', 'arrange', 'prepare'],
                'hope': ['anticipate', 'expect', 'aspire'],
                'wait': ['anticipate', 'expect', 'remain'],
                'follow': ['pursue', 'adhere', 'comply'],
                'lead': ['direct', 'guide', 'manage'],
                'meet': ['encounter', 'convene', 'assemble'],
                'join': ['participate', 'combine', 'unite'],
                'leave': ['depart', 'abandon', 'exit'],
                'stay': ['remain', 'continue', 'persist'],
                'return': ['revert', 'restore', 'respond'],
                'send': ['transmit', 'deliver', 'dispatch'],
                'receive': ['obtain', 'acquire', 'accept'],
                'buy': ['purchase', 'acquire', 'obtain'],
                'sell': ['market', 'distribute', 'exchange'],
                'pay': ['compensate', 'remunerate', 'contribute'],
                'spend': ['allocate', 'invest', 'utilize'],
                'save': ['preserve', 'conserve', 'maintain'],
                'lose': ['forfeit', 'sacrifice', 'surrender'],
                'win': ['achieve', 'succeed', 'accomplish'],
                'fail': ['unsuccessful', 'inadequate', 'insufficient'],
                'succeed': ['achieve', 'accomplish', 'complete'],
                'finish': ['complete', 'conclude', 'finalize'],
                'continue': ['proceed', 'persist', 'maintain'],
                
                // Time
                'quick': ['rapid', 'swift', 'immediate', 'prompt'],
                'fast': ['rapid', 'swift', 'accelerated'],
                'slow': ['gradual', 'deliberate', 'measured'],
                'early': ['preliminary', 'initial', 'advance'],
                'late': ['delayed', 'subsequent', 'final'],
                'new': ['recent', 'contemporary', 'modern', 'current'],
                'old': ['previous', 'former', 'traditional', 'established'],
                'young': ['junior', 'recent', 'emerging'],
                'long': ['extended', 'prolonged', 'extensive'],
                'short': ['brief', 'concise', 'limited'],
                
                // Frequency/Amount
                'many': ['numerous', 'multiple', 'various', 'several'],
                'much': ['considerable', 'substantial', 'significant'],
                'few': ['limited', 'minimal', 'scarce'],
                'little': ['minimal', 'slight', 'limited'],
                'more': ['additional', 'increased', 'enhanced'],
                'less': ['reduced', 'decreased', 'diminished'],
                'most': ['majority', 'predominant', 'primary'],
                'all': ['entire', 'complete', 'comprehensive'],
                'some': ['certain', 'particular', 'specific'],
                'every': ['each', 'individual', 'respective'],
                'each': ['individual', 'respective', 'particular'],
                'other': ['alternative', 'additional', 'different'],
                'another': ['alternative', 'additional', 'further'],
                'same': ['identical', 'equivalent', 'similar'],
                'different': ['distinct', 'alternative', 'varied'],
                
                // Position/Location
                'here': ['present', 'current', 'immediate'],
                'there': ['distant', 'remote', 'external'],
                'where': ['location', 'position', 'place'],
                'near': ['adjacent', 'proximate', 'close'],
                'far': ['distant', 'remote', 'separate'],
                'up': ['elevated', 'increased', 'superior'],
                'down': ['reduced', 'decreased', 'inferior'],
                'high': ['elevated', 'superior', 'advanced'],
                'low': ['reduced', 'minimal', 'basic'],
                'right': ['correct', 'appropriate', 'proper'],
                'wrong': ['incorrect', 'inappropriate', 'improper'],
                'next': ['subsequent', 'following', 'adjacent'],
                'last': ['final', 'ultimate', 'previous'],
                'first': ['initial', 'primary', 'original'],
                'second': ['subsequent', 'additional', 'alternative'],
                'best': ['optimal', 'superior', 'excellent'],
                'worst': ['inferior', 'inadequate', 'problematic'],
                'better': ['superior', 'improved', 'enhanced'],
                'worse': ['inferior', 'deteriorated', 'reduced'],
                'hard': ['difficult', 'challenging', 'complex'],
                'easy': ['simple', 'straightforward', 'accessible'],
                'simple': ['basic', 'fundamental', 'elementary'],
                'complex': ['complicated', 'sophisticated', 'intricate'],
                'clear': ['obvious', 'apparent', 'transparent'],
                'dark': ['obscure', 'unclear', 'ambiguous'],
                'light': ['minimal', 'slight', 'basic'],
                'heavy': ['substantial', 'significant', 'considerable'],
                'strong': ['powerful', 'robust', 'effective'],
                'weak': ['inadequate', 'insufficient', 'limited'],
                'full': ['complete', 'comprehensive', 'thorough'],
                'empty': ['vacant', 'unoccupied', 'void'],
                'open': ['accessible', 'available', 'transparent'],
                'closed': ['restricted', 'limited', 'concluded'],
                'hot': ['intense', 'extreme', 'significant'],
                'cold': ['distant', 'reserved', 'minimal'],
                'warm': ['positive', 'favorable', 'supportive'],
                'cool': ['moderate', 'controlled', 'measured'],
                'wet': ['saturated', 'abundant', 'excessive'],
                'dry': ['limited', 'minimal', 'basic'],
                'clean': ['pure', 'clear', 'appropriate'],
                'dirty': ['contaminated', 'problematic', 'inappropriate'],
                'safe': ['secure', 'protected', 'reliable'],
                'dangerous': ['hazardous', 'risky', 'problematic'],
                'free': ['available', 'unrestricted', 'independent'],
                'busy': ['occupied', 'engaged', 'active'],
                'ready': ['prepared', 'available', 'suitable'],
                'sure': ['certain', 'confident', 'definite'],
                'possible': ['potential', 'feasible', 'achievable'],
                'real': ['actual', 'genuine', 'authentic'],
                'true': ['accurate', 'correct', 'valid'],
                'false': ['incorrect', 'inaccurate', 'invalid']
            };
            
            // Map simple words to available vocabulary words
            Object.entries(commonMappings).forEach(([simple, alternatives]) => {
                for (let alt of alternatives) {
                    if (extractedWords.has(alt)) {
                        mappings[simple] = alt;
                        console.log(`Mapping: ${simple} ‚Üí ${alt}`);
                        break;
                    }
                }
            });
            
            console.log(`Created ${Object.keys(mappings).length} word mappings`);
            return mappings;
        }

        function createIntelligentMappings() {
            // Focus on high-quality, semantically appropriate mappings
            const mappings = {};
            const vocabularyArray = Array.from(extractedWords);
            
            console.log(`Creating intelligent mappings from ${vocabularyArray.length} vocabulary words...`);
            
            // Only high-confidence, semantically appropriate replacements
            const highQualityMappings = {
                // Only clear improvements that maintain meaning
                'important': ['crucial', 'essential', 'vital', 'significant', 'critical'],
                'show': ['demonstrate', 'illustrate', 'indicate', 'reveal', 'exhibit'],
                'use': ['utilize', 'employ', 'implement', 'apply'],
                'help': ['assist', 'support', 'facilitate', 'enable'],
                'big': ['substantial', 'significant', 'considerable', 'extensive'],
                'small': ['minimal', 'limited', 'marginal'],
                'good': ['effective', 'beneficial', 'positive', 'excellent'],
                'bad': ['detrimental', 'problematic', 'negative'],
                'change': ['modify', 'transform', 'adjust'],
                'problem': ['issue', 'challenge', 'difficulty'],
                'answer': ['solution', 'response', 'resolution'],
                'question': ['inquiry', 'issue', 'concern'],
                'think': ['consider', 'analyze', 'examine'],
                'find': ['discover', 'identify', 'locate'],
                'start': ['commence', 'initiate', 'begin'],
                'end': ['conclude', 'terminate', 'complete'],
                'create': ['establish', 'generate', 'develop'],
                'build': ['construct', 'develop', 'establish'],
                'grow': ['develop', 'expand', 'increase'],
                'learn': ['acquire', 'understand', 'comprehend'],
                'study': ['examine', 'analyze', 'investigate'],
                'understand': ['comprehend', 'grasp', 'recognize'],
                'believe': ['consider', 'maintain'],
                'decide': ['determine', 'conclude', 'resolve'],
                'choose': ['select', 'determine'],
                'follow': ['pursue', 'adhere'],
                'lead': ['direct', 'guide'],
                'meet': ['encounter', 'convene'],
                'join': ['participate', 'unite'],
                'work': ['function', 'operate'],
                'play': ['participate', 'engage'],
                'quick': ['rapid', 'swift'],
                'fast': ['rapid', 'swift'],
                'slow': ['gradual', 'deliberate'],
                'new': ['recent', 'contemporary', 'modern'],
                'old': ['previous', 'traditional', 'established'],
                'clear': ['obvious', 'apparent', 'transparent'],
                'different': ['distinct', 'alternative', 'varied'],
                'similar': ['comparable', 'equivalent'],
                'various': ['diverse', 'multiple'],
                'special': ['particular', 'specific', 'unique'],
                'general': ['overall', 'comprehensive'],
                'main': ['primary', 'principal', 'central'],
                'major': ['significant', 'substantial'],
                'simple': ['basic', 'fundamental'],
                'complex': ['complicated', 'sophisticated'],
                'difficult': ['challenging', 'demanding'],
                'easy': ['straightforward', 'accessible'],
                'strong': ['powerful', 'robust'],
                'effective': ['successful', 'beneficial'],
                'useful': ['beneficial', 'valuable'],
                'necessary': ['essential', 'required'],
                'possible': ['potential', 'feasible']
            };
            
            // Map to available vocabulary words with high confidence
            Object.entries(highQualityMappings).forEach(([simple, alternatives]) => {
                for (let alt of alternatives) {
                    if (extractedWords.has(alt)) {
                        mappings[simple] = alt;
                        console.log(`High-quality mapping: ${simple} ‚Üí ${alt}`);
                        break;
                    }
                }
            });
            
            // Only add additional mappings if they're from the same part of speech and frequent
            const additionalMappings = {};
            
            // Look for high-frequency vocabulary words that could replace common words
            vocabularyArray
                .filter(word => wordFrequency[word] >= 3) // Only frequent words
                .forEach(vocabWord => {
                    // Try to find a common word it could reasonably replace
                    const commonWord = findReasonableSimpleWord(vocabWord);
                    if (commonWord && !mappings[commonWord]) {
                        additionalMappings[commonWord] = vocabWord;
                    }
                });
            
            // Add the additional mappings
            Object.assign(mappings, additionalMappings);
            
            console.log(`Total intelligent mappings created: ${Object.keys(mappings).length}`);
            console.log('Focus: Quality over quantity, meaning preservation');
            return mappings;
        }

        function findReasonableSimpleWord(vocabWord) {
            // Conservative approach: only suggest replacements for very common words
            // that are clearly simpler versions of the vocabulary word
            
            const commonWords = {
                'establish': 'make',
                'demonstrate': 'show',
                'utilize': 'use',
                'facilitate': 'help',
                'substantial': 'big',
                'significant': 'important',
                'essential': 'important',
                'crucial': 'important',
                'comprehensive': 'complete',
                'contemporary': 'modern',
                'fundamental': 'basic',
                'sophisticated': 'complex',
                'challenging': 'hard',
                'beneficial': 'good',
                'detrimental': 'bad',
                'problematic': 'bad',
                'effective': 'good',
                'efficient': 'good',
                'appropriate': 'right',
                'considerable': 'big',
                'extensive': 'big',
                'minimal': 'small',
                'substantial': 'big'
            };
            
            return commonWords[vocabWord] || null;
        }

        function createEnhancedMappings() {
            // Create enhanced mappings with more coverage than intelligent but still smart
            const mappings = {};
            const vocabularyArray = Array.from(extractedWords);
            
            console.log(`Creating enhanced mappings from ${vocabularyArray.length} vocabulary words...`);
            
            // Start with high-quality mappings and expand coverage
            const enhancedMappings = {
                // Verbs - action words with clear academic alternatives
                'show': ['demonstrate', 'illustrate', 'indicate', 'reveal', 'exhibit', 'display'],
                'make': ['create', 'establish', 'generate', 'produce', 'construct'],
                'use': ['utilize', 'employ', 'implement', 'apply', 'adopt'],
                'help': ['assist', 'support', 'facilitate', 'enable', 'contribute'],
                'give': ['provide', 'supply', 'offer', 'present', 'deliver'],
                'take': ['acquire', 'obtain', 'receive', 'accept', 'secure'],
                'find': ['discover', 'identify', 'locate', 'determine', 'establish'],
                'tell': ['inform', 'communicate', 'convey', 'explain', 'describe'],
                'think': ['consider', 'analyze', 'examine', 'evaluate', 'contemplate'],
                'know': ['understand', 'comprehend', 'recognize', 'realize'],
                'feel': ['experience', 'perceive', 'sense', 'undergo'],
                'keep': ['maintain', 'preserve', 'retain', 'sustain'],
                'come': ['arrive', 'approach', 'emerge', 'appear'],
                'look': ['examine', 'observe', 'investigate', 'analyze'],
                'seem': ['appear', 'suggest', 'indicate', 'imply'],
                'turn': ['transform', 'convert', 'change', 'become'],
                'move': ['progress', 'advance', 'proceed', 'shift'],
                'lead': ['direct', 'guide', 'manage', 'conduct'],
                'bring': ['introduce', 'present', 'contribute', 'deliver'],
                'hold': ['maintain', 'retain', 'possess', 'contain'],
                'try': ['attempt', 'endeavor', 'strive', 'seek'],
                'ask': ['inquire', 'request', 'question', 'solicit'],
                'call': ['designate', 'refer', 'summon', 'contact'],
                'work': ['function', 'operate', 'perform', 'labor'],
                'play': ['participate', 'engage', 'perform', 'compete'],
                'run': ['operate', 'function', 'manage', 'execute'],
                'walk': ['proceed', 'advance', 'travel', 'progress'],
                'talk': ['communicate', 'discuss', 'converse', 'speak'],
                'read': ['examine', 'analyze', 'review', 'study'],
                'write': ['compose', 'document', 'record', 'draft'],
                'hear': ['perceive', 'detect', 'receive', 'understand'],
                'learn': ['acquire', 'understand', 'comprehend', 'master'],
                'teach': ['educate', 'instruct', 'demonstrate', 'train'],
                'study': ['examine', 'analyze', 'investigate', 'research'],
                'meet': ['encounter', 'convene', 'assemble', 'gather'],
                'follow': ['pursue', 'adhere', 'comply', 'track'],
                'change': ['modify', 'transform', 'adjust', 'alter'],
                'grow': ['develop', 'expand', 'increase', 'enhance'],
                'build': ['construct', 'develop', 'establish', 'create'],
                'open': ['access', 'reveal', 'initiate', 'commence'],
                'close': ['conclude', 'terminate', 'complete', 'finish'],
                'start': ['commence', 'initiate', 'begin', 'launch'],
                'stop': ['cease', 'terminate', 'discontinue', 'halt'],
                'finish': ['complete', 'conclude', 'finalize', 'end'],
                'continue': ['proceed', 'persist', 'maintain', 'sustain'],
                'plan': ['organize', 'arrange', 'prepare', 'design'],
                'hope': ['anticipate', 'expect', 'aspire', 'desire'],
                'believe': ['consider', 'maintain', 'assume', 'trust'],
                'remember': ['recall', 'recollect', 'retain', 'preserve'],
                'forget': ['overlook', 'neglect', 'omit', 'disregard'],
                'choose': ['select', 'decide', 'determine', 'opt'],
                'decide': ['determine', 'conclude', 'resolve', 'choose'],
                'wait': ['anticipate', 'expect', 'remain', 'pause'],
                'stay': ['remain', 'continue', 'persist', 'endure'],
                'leave': ['depart', 'abandon', 'exit', 'withdraw'],
                'join': ['participate', 'unite', 'combine', 'connect'],
                'lose': ['forfeit', 'sacrifice', 'surrender', 'misplace'],
                'win': ['achieve', 'succeed', 'accomplish', 'triumph'],
                'fail': ['unsuccessful', 'inadequate', 'insufficient'],
                'succeed': ['achieve', 'accomplish', 'complete', 'attain'],
                
                // Nouns - concrete and abstract concepts
                'people': ['individuals', 'persons', 'citizens', 'population'],
                'person': ['individual', 'citizen', 'resident', 'character'],
                'group': ['organization', 'association', 'community', 'collective'],
                'place': ['location', 'position', 'site', 'area'],
                'time': ['period', 'duration', 'moment', 'interval'],
                'part': ['component', 'element', 'section', 'portion'],
                'number': ['quantity', 'amount', 'figure', 'total'],
                'point': ['aspect', 'element', 'factor', 'consideration'],
                'area': ['region', 'zone', 'territory', 'district'],
                'problem': ['issue', 'challenge', 'difficulty', 'concern'],
                'fact': ['reality', 'truth', 'evidence', 'information'],
                'case': ['situation', 'instance', 'example', 'circumstance'],
                'way': ['method', 'approach', 'technique', 'manner'],
                'water': ['liquid', 'fluid', 'substance', 'resource'],
                'money': ['currency', 'funds', 'capital', 'resources'],
                'story': ['narrative', 'account', 'report', 'description'],
                'idea': ['concept', 'notion', 'thought', 'proposal'],
                'question': ['inquiry', 'issue', 'concern', 'matter'],
                'answer': ['solution', 'response', 'resolution', 'reply'],
                'result': ['outcome', 'consequence', 'effect', 'conclusion'],
                'change': ['modification', 'transformation', 'adjustment'],
                'reason': ['explanation', 'justification', 'cause', 'motive'],
                'system': ['structure', 'organization', 'framework', 'network'],
                'power': ['authority', 'influence', 'control', 'strength'],
                'value': ['importance', 'worth', 'significance', 'merit'],
                'level': ['degree', 'extent', 'standard', 'measure'],
                'order': ['sequence', 'arrangement', 'organization', 'structure'],
                'state': ['condition', 'situation', 'status', 'circumstances'],
                'line': ['boundary', 'limit', 'border', 'sequence'],
                'house': ['residence', 'dwelling', 'home', 'building'],
                'room': ['space', 'area', 'chamber', 'facility'],
                'family': ['household', 'relatives', 'kinship', 'clan'],
                'school': ['institution', 'academy', 'establishment'],
                'company': ['organization', 'corporation', 'enterprise', 'firm'],
                'business': ['enterprise', 'organization', 'operation', 'venture'],
                
                // Adjectives - descriptive words with academic alternatives  
                'big': ['substantial', 'significant', 'considerable', 'extensive'],
                'small': ['minimal', 'limited', 'marginal', 'minor'],
                'good': ['effective', 'beneficial', 'positive', 'excellent'],
                'bad': ['detrimental', 'problematic', 'negative', 'adverse'],
                'great': ['excellent', 'outstanding', 'remarkable', 'exceptional'],
                'important': ['crucial', 'essential', 'vital', 'significant'],
                'new': ['recent', 'contemporary', 'modern', 'current'],
                'old': ['previous', 'former', 'traditional', 'established'],
                'long': ['extended', 'prolonged', 'extensive', 'lengthy'],
                'short': ['brief', 'concise', 'limited', 'compact'],
                'high': ['elevated', 'superior', 'advanced', 'prominent'],
                'low': ['reduced', 'minimal', 'basic', 'inferior'],
                'right': ['correct', 'appropriate', 'proper', 'accurate'],
                'wrong': ['incorrect', 'inappropriate', 'improper', 'inaccurate'],
                'clear': ['obvious', 'apparent', 'transparent', 'evident'],
                'hard': ['difficult', 'challenging', 'complex', 'demanding'],
                'easy': ['simple', 'straightforward', 'accessible', 'effortless'],
                'free': ['available', 'unrestricted', 'independent', 'accessible'],
                'real': ['actual', 'genuine', 'authentic', 'legitimate'],
                'true': ['accurate', 'correct', 'valid', 'authentic'],
                'false': ['incorrect', 'inaccurate', 'invalid', 'erroneous'],
                'quick': ['rapid', 'swift', 'immediate', 'prompt'],
                'fast': ['rapid', 'swift', 'accelerated', 'speedy'],
                'slow': ['gradual', 'deliberate', 'measured', 'unhurried'],
                'strong': ['powerful', 'robust', 'effective', 'influential'],
                'weak': ['inadequate', 'insufficient', 'limited', 'feeble'],
                'full': ['complete', 'comprehensive', 'thorough', 'entire'],
                'empty': ['vacant', 'unoccupied', 'void', 'hollow'],
                'open': ['accessible', 'available', 'transparent', 'public'],
                'closed': ['restricted', 'limited', 'concluded', 'sealed'],
                'young': ['junior', 'youthful', 'recent', 'emerging'],
                'different': ['distinct', 'alternative', 'varied', 'diverse'],
                'same': ['identical', 'equivalent', 'similar', 'uniform'],
                'similar': ['comparable', 'equivalent', 'analogous', 'related'],
                'various': ['diverse', 'multiple', 'different', 'assorted'],
                'special': ['particular', 'specific', 'unique', 'distinctive'],
                'general': ['overall', 'comprehensive', 'broad', 'universal'],
                'main': ['primary', 'principal', 'central', 'chief'],
                'major': ['significant', 'substantial', 'important', 'primary'],
                'minor': ['small', 'insignificant', 'secondary', 'trivial'],
                'simple': ['basic', 'fundamental', 'elementary', 'uncomplicated'],
                'complex': ['complicated', 'sophisticated', 'intricate', 'elaborate'],
                'difficult': ['challenging', 'demanding', 'complicated', 'arduous'],
                'possible': ['potential', 'feasible', 'achievable', 'viable'],
                'necessary': ['essential', 'required', 'vital', 'mandatory'],
                'available': ['accessible', 'obtainable', 'ready', 'present'],
                'useful': ['beneficial', 'valuable', 'helpful', 'practical'],
                'effective': ['successful', 'beneficial', 'productive', 'efficient'],
                'political': ['governmental', 'administrative', 'civic', 'public'],
                'social': ['community', 'societal', 'collective', 'interpersonal'],
                'economic': ['financial', 'monetary', 'commercial', 'fiscal'],
                'public': ['community', 'collective', 'general', 'open'],
                'private': ['personal', 'individual', 'confidential', 'exclusive'],
                'local': ['regional', 'community', 'neighborhood', 'municipal'],
                'national': ['federal', 'governmental', 'countrywide', 'state'],
                'personal': ['individual', 'private', 'subjective', 'intimate'],
                'final': ['ultimate', 'concluding', 'terminal', 'definitive'],
                'total': ['complete', 'entire', 'comprehensive', 'absolute'],
                'black': ['dark', 'ebony', 'noir', 'charcoal'],
                'white': ['pale', 'light', 'bright', 'clear'],
                'recent': ['contemporary', 'current', 'modern', 'latest'],
                
                // Adverbs - manner and degree modifiers
                'very': ['extremely', 'significantly', 'considerably', 'substantially'],
                'quite': ['rather', 'fairly', 'reasonably', 'moderately'],
                'really': ['actually', 'genuinely', 'truly', 'certainly'],
                'often': ['frequently', 'regularly', 'commonly', 'habitually'],
                'sometimes': ['occasionally', 'periodically', 'intermittently'],
                'always': ['consistently', 'continuously', 'perpetually', 'invariably'],
                'never': ['rarely', 'infrequently', 'seldom', 'hardly'],
                'well': ['effectively', 'successfully', 'properly', 'adequately'],
                'too': ['excessively', 'overly', 'extremely', 'additionally'],
                'only': ['exclusively', 'solely', 'merely', 'simply'],
                'still': ['nevertheless', 'nonetheless', 'however', 'yet'],
                'also': ['additionally', 'furthermore', 'moreover', 'likewise'],
                'even': ['including', 'despite', 'although', 'surprisingly'],
                'perhaps': ['possibly', 'potentially', 'conceivably', 'maybe'],
                'probably': ['likely', 'presumably', 'apparently', 'seemingly'],
                'certainly': ['definitely', 'absolutely', 'undoubtedly', 'surely'],
                'quickly': ['rapidly', 'swiftly', 'promptly', 'immediately'],
                'slowly': ['gradually', 'deliberately', 'carefully', 'steadily'],
                'clearly': ['obviously', 'evidently', 'apparently', 'distinctly'],
                'suddenly': ['abruptly', 'unexpectedly', 'immediately', 'instantly'],
                'usually': ['typically', 'generally', 'commonly', 'ordinarily'],
                'finally': ['ultimately', 'eventually', 'conclusively', 'lastly'],
                'mostly': ['primarily', 'predominantly', 'mainly', 'largely'],
                'especially': ['particularly', 'specifically', 'notably', 'especially'],
                'completely': ['entirely', 'totally', 'absolutely', 'thoroughly'],
                'exactly': ['precisely', 'specifically', 'accurately', 'literally'],
                'almost': ['nearly', 'approximately', 'virtually', 'practically']
            };
            
            // Map to available vocabulary words
            Object.entries(enhancedMappings).forEach(([simple, alternatives]) => {
                for (let alt of alternatives) {
                    if (extractedWords.has(alt)) {
                        mappings[simple] = alt;
                        console.log(`Enhanced mapping: ${simple} ‚Üí ${alt}`);
                        break;
                    }
                }
            });
            
            // Add POS-based mappings from extracted words
            const posMappings = createPOSBasedMappings();
            Object.assign(mappings, posMappings);
            
            console.log(`Total enhanced mappings created: ${Object.keys(mappings).length}`);
            console.log('Focus: Balanced coverage with meaning preservation');
            return mappings;
        }

        function createPOSBasedMappings() {
            // Create additional mappings based on part-of-speech categories
            const mappings = {};
            
            // Map simple words to vocabulary words of the same POS
            const simplePOSWords = {
                'Nouns': ['thing', 'stuff', 'things', 'items', 'objects', 'elements'],
                'Verbs': ['do', 'go', 'get', 'put', 'see', 'say', 'let', 'set'],
                'Adjectives': ['nice', 'cool', 'okay', 'fine', 'normal', 'regular'],
                'Adverbs': ['so', 'just', 'now', 'then', 'here', 'there']
            };
            
            Object.entries(wordsByPOS).forEach(([pos, vocabWords]) => {
                if (pos === 'Other') return; // Skip 'Other' category
                
                const vocabArray = Object.keys(vocabWords);
                const simpleWords = simplePOSWords[pos] || [];
                
                simpleWords.forEach(simpleWord => {
                    if (!mappings[simpleWord] && vocabArray.length > 0) {
                        // Pick the most frequent vocabulary word of this POS
                        const sorted = vocabArray.sort((a, b) => vocabWords[b] - vocabWords[a]);
                        mappings[simpleWord] = sorted[0];
                        console.log(`POS-based mapping (${pos}): ${simpleWord} ‚Üí ${sorted[0]}`);
                    }
                });
            });
            
            return mappings;
        }

        function copyPracticeMaterial() {
            const text = processedArticle.textContent || processedArticle.innerText;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    // Temporarily change button text
                    const originalText = copyToClipboard.textContent;
                    copyToClipboard.textContent = '‚úÖ Copied!';
                    copyToClipboard.classList.remove('bg-green-500', 'hover:bg-green-600');
                    copyToClipboard.classList.add('bg-green-600');
                    
                    setTimeout(() => {
                        copyToClipboard.textContent = originalText;
                        copyToClipboard.classList.remove('bg-green-600');
                        copyToClipboard.classList.add('bg-green-500', 'hover:bg-green-600');
                    }, 2000);
                });
            }
        }

        // Helper function to update progress message
        function updateProgressMessage(message) {
            const progressElement = document.querySelector('#extractionProgress p');
            if (progressElement) {
                progressElement.textContent = message;
            }
        }

        // OCR function for image-based PDFs with better error handling
        async function extractTextWithOCR(pdf) {
            let ocrText = '';
            const maxPages = Math.min(pdf.numPages, 8); // Process all pages for this 8-page document
            
            try {
                // Check if Tesseract is available
                if (typeof Tesseract === 'undefined') {
                    throw new Error('OCR library not loaded. Please refresh the page and try again.');
                }
                
                updateProgressMessage('üîÑ Initializing OCR engine...');
                
                for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                    updateProgressMessage(`üì∑ OCR Processing page ${pageNum} of ${maxPages}...`);
                    console.log(`Starting OCR for page ${pageNum}`);
                    
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1.5 }); // Reduce scale for better performance
                    
                    // Create canvas to render PDF page
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    // Render PDF page to canvas
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    // Convert canvas to blob for better performance
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    
                    try {
                        // Use Tesseract.js for OCR with simpler configuration
                        const worker = await Tesseract.createWorker('eng');
                        const result = await worker.recognize(blob);
                        await worker.terminate();
                        
                        const pageText = result.data.text;
                        ocrText += pageText + '\n';
                        console.log(`OCR completed for page ${pageNum}, extracted ${pageText.length} characters`);
                        
                        // Update progress with actual results
                        updateProgressMessage(`üì∑ Page ${pageNum} complete (${pageText.length} chars extracted)`);
                        
                    } catch (pageError) {
                        console.warn(`OCR failed for page ${pageNum}:`, pageError);
                        updateProgressMessage(`‚ö†Ô∏è Page ${pageNum} skipped (OCR error)`);
                        // Continue with other pages
                    }
                    
                    // Clean up canvas
                    canvas.remove();
                    
                    // Small delay to prevent browser freezing
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (ocrText.trim().length === 0) {
                    throw new Error('OCR could not extract any readable text from the PDF images. This may be due to poor image quality, unusual fonts, or the PDF containing only diagrams/images without text.');
                }
                
                console.log(`OCR completed successfully. Total extracted text: ${ocrText.length} characters`);
                return ocrText;
                
            } catch (error) {
                console.error('OCR Error:', error);
                
                // Provide more helpful error messages
                if (error.message.includes('OCR library not loaded')) {
                    throw new Error('OCR feature unavailable. Please refresh the page and try again. If the problem persists, your scanned PDF might need to be processed using other tools.');
                } else if (error.message.includes('Failed to fetch')) {
                    throw new Error('Network error while loading OCR engine. Please check your internet connection and try again.');
                } else {
                    throw new Error(`OCR processing failed: ${error.message}. Try using a higher quality scan or a different PDF file.`);
                }
            }
        }

        // Page Navigation Functions
        function switchPage(page) {
            // Hide all pages
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('generatePage').classList.add('hidden');
            document.getElementById('practicePage').classList.add('hidden');
            document.getElementById('chatPage').classList.add('hidden');
            
            // Reset navigation tabs
            document.getElementById('mainPageTab').className = 'px-4 py-2 text-blue-100 rounded-md text-sm hover:bg-white hover:bg-opacity-20 transition-colors';
            document.getElementById('generatePageTab').className = 'px-4 py-2 text-blue-100 rounded-md text-sm hover:bg-white hover:bg-opacity-20 transition-colors';
            document.getElementById('practicePageTab').className = 'px-4 py-2 text-blue-100 rounded-md text-sm hover:bg-white hover:bg-opacity-20 transition-colors';
            document.getElementById('chatPageTab').className = 'px-4 py-2 text-blue-100 rounded-md text-sm hover:bg-white hover:bg-opacity-20 transition-colors';
            
            // Show selected page and activate tab
            if (page === 'main') {
                document.getElementById('mainPage').classList.remove('hidden');
                document.getElementById('mainPageTab').className = 'px-4 py-2 bg-white bg-opacity-20 text-white rounded-md text-sm hover:bg-opacity-30 transition-colors';
            } else if (page === 'generate') {
                document.getElementById('generatePage').classList.remove('hidden');
                document.getElementById('generatePageTab').className = 'px-4 py-2 bg-white bg-opacity-20 text-white rounded-md text-sm hover:bg-opacity-30 transition-colors';
                updateGeneratePageWordCount();
            } else if (page === 'practice') {
                document.getElementById('practicePage').classList.remove('hidden');
                document.getElementById('practicePageTab').className = 'px-4 py-2 bg-white bg-opacity-20 text-white rounded-md text-sm hover:bg-opacity-30 transition-colors';
                showPracticeMenu();
            } else if (page === 'chat') {
                document.getElementById('chatPage').classList.remove('hidden');
                document.getElementById('chatPageTab').className = 'px-4 py-2 bg-white bg-opacity-20 text-white rounded-md text-sm hover:bg-opacity-30 transition-colors';
                updateChatPageStats();
            }
        }

        function updateGeneratePageWordCount() {
            document.getElementById('availableWords').textContent = extractedWords.size;
            
            if (extractedWords.size === 0) {
                document.getElementById('generateArticle').disabled = true;
                document.getElementById('generateArticle').textContent = '‚ö†Ô∏è Extract words first';
            } else {
                document.getElementById('generateArticle').disabled = false;
                document.getElementById('generateArticle').textContent = '‚ú® Generate Article';
            }
        }

        // Article Generation Functions
        function handleArticleGeneration() {
            if (extractedWords.size === 0) {
                alert('Please extract vocabulary words first from the Main page.');
                return;
            }
            
            const length = document.getElementById('articleLength').value;
            const topic = document.getElementById('articleTopic').value;
            const intensity = parseInt(document.getElementById('vocabIntensity').value);
            
            console.log(`Generating ${length} article about ${topic} with ${intensity}% vocabulary intensity`);
            
            const generatedText = generateArticleText(length, topic, intensity);
            
            // Display the generated article
            document.getElementById('generatedArticle').textContent = generatedText;
            document.getElementById('generatedArticleSection').classList.remove('hidden');
            document.getElementById('regenerateArticle').classList.remove('hidden');
            
            // Count vocabulary words used
            const usedCount = countVocabularyWordsInText(generatedText);
            document.getElementById('usedWordsCount').textContent = usedCount;
        }

        function generateArticleText(length, topic, intensity) {
            // Get word counts based on length with extended options
            const wordCounts = {
                'short': { min: 100, max: 150 },
                'medium': { min: 200, max: 300 },
                'long': { min: 400, max: 500 },
                'extended': { min: 600, max: 800 },
                'comprehensive': { min: 1000, max: 1200 },
                'detailed': { min: 1500, max: 2000 }
            };
            
            const targetWords = Math.floor(Math.random() * (wordCounts[length].max - wordCounts[length].min + 1)) + wordCounts[length].min;
            const vocabWordsToUse = Math.floor((targetWords * intensity) / 100);
            
            // Topic-based content templates
            const topicTemplates = {
                'education': generateEducationArticle,
                'technology': generateTechnologyArticle,
                'environment': generateEnvironmentArticle,
                'health': generateHealthArticle,
                'business': generateBusinessArticle,
                'culture': generateCultureArticle,
                'science': generateScienceArticle,
                'general': generateGeneralArticle
            };
            
            const generator = topicTemplates[topic] || generateGeneralArticle;
            return generator(targetWords, vocabWordsToUse);
        }

        function generateEducationArticle(targetWords, vocabWordsToUse) {
            const vocabArray = Array.from(extractedWords);
            const usedVocab = [];
            
            // Define paragraph themes and sentence pools
            const paragraphThemes = [
                {
                    theme: "Foundation of Education",
                    sentences: [
                        "Education plays a crucial role in shaping society.",
                        "Students need to [VOCAB] knowledge effectively to succeed in their academic journey.",
                        "Educational institutions should [VOCAB] comprehensive programs that address diverse learning needs.",
                        "The curriculum must be [VOCAB] to meet the changing demands of the modern world."
                    ]
                },
                {
                    theme: "Teaching Methods",
                    sentences: [
                        "Teachers must [VOCAB] innovative methods to engage learners in the classroom.",
                        "Assessment methods should [VOCAB] various forms of intelligence and abilities.",
                        "Instructors need to [VOCAB] creative strategies that cater to different learning styles.",
                        "Effective pedagogy [VOCAB] student-centered approaches to maximize engagement."
                    ]
                },
                {
                    theme: "Technology in Education",
                    sentences: [
                        "Technology has [VOCAB] the way students access and process information.",
                        "Digital platforms [VOCAB] new opportunities for collaborative learning.",
                        "Online resources [VOCAB] educational accessibility for students worldwide.",
                        "Educational technology [VOCAB] traditional classroom boundaries."
                    ]
                },
                {
                    theme: "Research and Outcomes",
                    sentences: [
                        "Research shows that [VOCAB] learning environments lead to better academic outcomes.",
                        "Educational policies need to be [VOCAB] based on evidence and best practices.",
                        "Studies [VOCAB] that parental involvement significantly impacts student success.",
                        "Data-driven approaches [VOCAB] more effective educational strategies."
                    ]
                },
                {
                    theme: "Future of Education",
                    sentences: [
                        "The goal is to [VOCAB] critical thinking skills in all students.",
                        "Parents and educators must [VOCAB] together to support student development.",
                        "Educational excellence [VOCAB] continuous improvement and adaptation.",
                        "Future learning models will [VOCAB] personalized and flexible approaches."
                    ]
                }
            ];
            
            return generateParagraphedArticle(paragraphThemes, targetWords, vocabWordsToUse, vocabArray);
        }

        function generateParagraphedArticle(paragraphThemes, targetWords, vocabWordsToUse, vocabArray) {
            let article = '';
            let totalWordsUsed = 0;
            let vocabWordsUsed = 0;
            const wordsPerParagraph = Math.floor(targetWords / paragraphThemes.length);
            const vocabPerParagraph = Math.floor(vocabWordsToUse / paragraphThemes.length);
            
            console.log(`Target: ${targetWords} words, ${wordsPerParagraph} per paragraph`);
            
            paragraphThemes.forEach((theme, themeIndex) => {
                let paragraph = '';
                let paragraphWordCount = 0;
                let paragraphVocab = 0;
                
                // Add all base sentences from this theme
                theme.sentences.forEach(sentence => {
                    // Replace [VOCAB] with vocabulary words
                    if (sentence.includes('[VOCAB]') && paragraphVocab < vocabPerParagraph && vocabWordsUsed < vocabWordsToUse) {
                        if (vocabArray.length > 0) {
                            const randomVocab = vocabArray[Math.floor(Math.random() * vocabArray.length)];
                            sentence = sentence.replace('[VOCAB]', randomVocab);
                            vocabWordsUsed++;
                            paragraphVocab++;
                        } else {
                            const fallbackWords = {
                                'Foundation of Education': 'develop',
                                'Teaching Methods': 'implement',
                                'Technology in Education': 'enhance',
                                'Research and Outcomes': 'demonstrate',
                                'Future of Education': 'establish'
                            };
                            sentence = sentence.replace('[VOCAB]', fallbackWords[theme.theme] || 'create');
                        }
                    } else if (sentence.includes('[VOCAB]')) {
                        const simpleWords = ['improve', 'support', 'develop', 'create', 'enhance', 'provide', 'ensure', 'promote'];
                        const randomSimple = simpleWords[Math.floor(Math.random() * simpleWords.length)];
                        sentence = sentence.replace('[VOCAB]', randomSimple);
                    }
                    
                    paragraph += sentence + ' ';
                    const sentenceWordCount = sentence.split(' ').length;
                    paragraphWordCount += sentenceWordCount;
                    totalWordsUsed += sentenceWordCount;
                });
                
                // Add additional content to reach paragraph target
                const remainingWordsNeeded = wordsPerParagraph - paragraphWordCount;
                if (remainingWordsNeeded > 0) {
                    const additionalContent = generateAdditionalContent(theme.theme, vocabArray, remainingWordsNeeded, targetWords);
                    if (additionalContent) {
                        paragraph += additionalContent + ' ';
                        const additionalWords = additionalContent.split(' ').length;
                        paragraphWordCount += additionalWords;
                        totalWordsUsed += additionalWords;
                    }
                }
                
                // Add paragraph break
                if (paragraph.trim()) {
                    article += paragraph.trim() + '\n\n';
                }
                
                console.log(`Paragraph ${themeIndex + 1}: ${paragraphWordCount} words, Total: ${totalWordsUsed} words`);
            });
            
            // Add more content if we're still significantly under target
            if (totalWordsUsed < targetWords * 0.85) {
                const remainingWords = targetWords - totalWordsUsed;
                console.log(`Adding ${remainingWords} more words to reach target`);
                const extensiveConclusion = generateExtensiveConclusion(remainingWords, vocabArray);
                article += extensiveConclusion;
                totalWordsUsed += extensiveConclusion.split(' ').length;
            }
            
            console.log(`Final article: ${totalWordsUsed} words (target: ${targetWords})`);
            return article.trim();
        }
        
        function generateAdditionalContent(theme, vocabArray, wordsNeeded, targetWords) {
            // Expanded content pools for longer articles
            const additionalContent = {
                'Foundation of Education': [
                    "Modern educational systems must adapt to changing societal needs and technological advances.",
                    "Quality education serves as the foundation for personal growth and professional development.",
                    "Educational institutions play a vital role in shaping future leaders and innovators.",
                    "Access to quality education remains a fundamental human right across all communities.",
                    "Educational equity ensures that all students have the opportunity to succeed regardless of background.",
                    "The curriculum should be comprehensive, inclusive, and reflective of diverse perspectives and experiences.",
                    "Learning environments must be safe, supportive, and conducive to intellectual and social development.",
                    "Educational leadership requires vision, commitment, and the ability to inspire positive change.",
                    "Student-centered approaches prioritize individual learning needs and promote active engagement.",
                    "The foundation of education rests on strong relationships between teachers, students, and families.",
                    "Quality education incorporates both academic rigor and social-emotional learning components.",
                    "Educational standards should be challenging yet achievable, promoting excellence for all learners."
                ],
                'Teaching Methods': [
                    "Effective teaching requires continuous professional development and adaptation to new methodologies.",
                    "Student engagement increases when educators employ diverse instructional strategies.",
                    "Collaborative learning environments foster critical thinking and problem-solving skills.",
                    "Assessment should be ongoing and provide meaningful feedback to support student progress.",
                    "Differentiated instruction addresses the unique learning styles and needs of individual students.",
                    "Project-based learning connects classroom concepts to real-world applications and experiences.",
                    "Formative assessment provides immediate feedback and enables teachers to adjust instruction accordingly.",
                    "Peer learning and cooperative strategies enhance understanding through social interaction.",
                    "Technology-enhanced teaching methods can increase student motivation and engagement levels.",
                    "Inquiry-based learning encourages students to ask questions and explore topics deeply.",
                    "Culturally responsive teaching acknowledges and builds upon students' cultural backgrounds.",
                    "Scaffolding techniques provide temporary support while building student independence and confidence."
                ],
                'Technology in Education': [
                    "Digital tools have revolutionized how students access and interact with educational content.",
                    "Virtual learning platforms enable flexible and personalized educational experiences.",
                    "Technology integration must be purposeful and aligned with learning objectives.",
                    "Digital literacy has become an essential skill for success in the modern world.",
                    "Online collaboration tools connect students and educators across geographical boundaries.",
                    "Adaptive learning software personalizes instruction based on individual student performance.",
                    "Digital portfolios showcase student work and track learning progress over time.",
                    "Simulation and virtual reality technologies provide immersive learning experiences.",
                    "Educational apps and software can supplement traditional instruction and practice.",
                    "Data analytics help educators identify learning patterns and areas for improvement.",
                    "Digital citizenship education teaches responsible and ethical use of technology.",
                    "Blended learning combines online and face-to-face instruction for optimal flexibility."
                ],
                'Research and Outcomes': [
                    "Educational research provides valuable insights into effective teaching and learning practices.",
                    "Evidence-based decision making leads to improved educational policies and outcomes.",
                    "Longitudinal studies help track the long-term impact of educational interventions.",
                    "Data analysis reveals patterns that can inform future educational strategies.",
                    "Research findings must be translated into practical applications for classroom use.",
                    "Collaborative research efforts involve teachers, administrators, and academic researchers.",
                    "Student achievement data helps identify successful programs and areas needing improvement.",
                    "Peer-reviewed studies contribute to the broader understanding of educational effectiveness.",
                    "Action research empowers educators to investigate and improve their own practice.",
                    "Meta-analyses synthesize findings from multiple studies to identify consistent patterns.",
                    "Research-based interventions show greater effectiveness than untested approaches.",
                    "Continuous evaluation ensures that educational programs meet their intended goals."
                ],
                'Future of Education': [
                    "The future of education will emphasize personalized learning and individual student needs.",
                    "Lifelong learning will become increasingly important in rapidly changing job markets.",
                    "Educational institutions must prepare students for careers that may not yet exist.",
                    "Global collaboration and cultural competence will be essential skills for future graduates.",
                    "Artificial intelligence and machine learning will transform educational delivery and assessment.",
                    "Flexible learning pathways will accommodate diverse student interests and career goals.",
                    "Environmental sustainability education will prepare students for global challenges.",
                    "Social and emotional learning will be integrated throughout the curriculum.",
                    "Competency-based progression will replace traditional age-based grade structures.",
                    "Community partnerships will expand learning opportunities beyond school walls.",
                    "Innovation and creativity will be cultivated as essential 21st-century skills.",
                    "Educational institutions will become learning hubs that serve entire communities."
                ]
            };
            
            const sentences = additionalContent[theme] || [];
            let content = '';
            let wordCount = 0;
            
            // For longer articles, use more sentences
            const maxSentences = targetWords > 800 ? sentences.length : Math.min(6, sentences.length);
            
            for (let i = 0; i < maxSentences && wordCount < wordsNeeded; i++) {
                const sentence = sentences[i];
                if (sentence) {
                    content += sentence + ' ';
                    wordCount += sentence.split(' ').length;
                }
            }
            
            return content.trim();
        }
        
        function generateExtensiveConclusion(wordsNeeded, vocabArray) {
            const extensiveConclusions = [
                "Educational excellence requires ongoing commitment from all stakeholders in the learning process.",
                "Success in education depends on collaboration between educators, students, families, and communities.",
                "The pursuit of knowledge and understanding remains central to human progress and development.",
                "Quality education empowers individuals to contribute meaningfully to society and their communities.",
                "Continuous improvement and innovation drive the evolution of educational practices and outcomes.",
                "Educational institutions must remain responsive to changing needs and emerging opportunities.",
                "The investment in education yields long-term benefits for individuals and society as a whole.",
                "Effective education prepares students for active citizenship and lifelong learning.",
                "Educational policies should reflect evidence-based practices and research findings.",
                "The future depends on our collective commitment to providing quality education for all.",
                "Inclusive education ensures that every student has access to high-quality learning opportunities.",
                "Professional development for educators is essential for maintaining educational excellence.",
                "Technology integration should enhance rather than replace effective teaching practices.",
                "Assessment practices must be fair, accurate, and supportive of student learning goals.",
                "Educational leadership plays a crucial role in creating positive school climates and cultures.",
                "Parent and community engagement strengthens the educational experience for all students.",
                "Multicultural education promotes understanding and respect for diversity in society.",
                "Critical thinking skills prepare students to navigate complex challenges and decisions.",
                "Educational research continues to inform and improve teaching and learning practices.",
                "The goal of education is to develop knowledgeable, skilled, and responsible citizens.",
                "Educational innovation requires careful planning, implementation, and evaluation.",
                "Student voice and choice enhance engagement and ownership of the learning process.",
                "Educational equity means providing all students with what they need to succeed.",
                "The teaching profession requires dedication, expertise, and ongoing professional growth.",
                "Educational partnerships create opportunities for authentic and meaningful learning experiences."
            ];
            
            let conclusion = '';
            let wordCount = 0;
            
            // Shuffle the conclusions to ensure variety
            const shuffledConclusions = [...extensiveConclusions].sort(() => Math.random() - 0.5);
            
            for (const sentence of shuffledConclusions) {
                if (wordCount >= wordsNeeded) break;
                conclusion += sentence + ' ';
                wordCount += sentence.split(' ').length;
            }
            
            return conclusion.trim();
        }
        
        function generateConclusion(wordsNeeded, vocabArray) {
            const conclusions = [
                "Educational excellence requires ongoing commitment from all stakeholders in the learning process.",
                "Success in education depends on collaboration between educators, students, families, and communities.",
                "The pursuit of knowledge and understanding remains central to human progress and development.",
                "Quality education empowers individuals to contribute meaningfully to society and their communities.",
                "Continuous improvement and innovation drive the evolution of educational practices and outcomes.",
                "Educational institutions must remain responsive to changing needs and emerging opportunities.",
                "The investment in education yields long-term benefits for individuals and society as a whole.",
                "Effective education prepares students for active citizenship and lifelong learning.",
                "Educational policies should reflect evidence-based practices and research findings.",
                "The future depends on our collective commitment to providing quality education for all."
            ];
            
            let conclusion = '';
            let wordCount = 0;
            
            while (wordCount < wordsNeeded && conclusions.length > 0) {
                const randomIndex = Math.floor(Math.random() * conclusions.length);
                const sentence = conclusions.splice(randomIndex, 1)[0];
                conclusion += sentence + ' ';
                wordCount += sentence.split(' ').length;
            }
            
            return conclusion.trim();
        }

        function generateTechnologyArticle(targetWords, vocabWordsToUse) {
            const vocabArray = Array.from(extractedWords);
            let article = "Technology continues to transform our daily lives. ";
            
            const sentences = [
                "Digital innovations [VOCAB] new possibilities for communication and collaboration.",
                "Companies must [VOCAB] cutting-edge solutions to remain competitive in the market.",
                "Artificial intelligence is [VOCAB] to revolutionize various industries.",
                "Cybersecurity measures need to be [VOCAB] to protect sensitive information.",
                "Mobile applications have [VOCAB] the way people interact with services.",
                "Cloud computing provides [VOCAB] infrastructure for modern businesses.",
                "Data analytics helps organizations [VOCAB] informed decisions.",
                "The Internet of Things [VOCAB] everyday objects with smart capabilities.",
                "Automation technologies [VOCAB] efficiency in manufacturing processes.",
                "Future innovations will [VOCAB] even more advanced technological solutions."
            ];
            
            let wordsAdded = 0;
            for (let sentence of sentences) {
                if (wordsAdded >= vocabWordsToUse) break;
                
                if (vocabArray.length > 0) {
                    const randomVocab = vocabArray[Math.floor(Math.random() * vocabArray.length)];
                    sentence = sentence.replace('[VOCAB]', randomVocab);
                    wordsAdded++;
                } else {
                    sentence = sentence.replace('[VOCAB]', 'create');
                }
                
                article += sentence + " ";
                if (article.split(' ').length >= targetWords) break;
            }
            
            while (article.split(' ').length < targetWords) {
                article += "Technological advancement drives global progress and innovation. ";
            }
            
            return article.trim();
        }

        function generateEnvironmentArticle(targetWords, vocabWordsToUse) {
            const vocabArray = Array.from(extractedWords);
            let article = "Environmental protection is essential for sustainable development. ";
            
            const sentences = [
                "Climate change [VOCAB] immediate action from governments worldwide.",
                "Renewable energy sources [VOCAB] clean alternatives to fossil fuels.",
                "Conservation efforts must [VOCAB] biodiversity and natural habitats.",
                "Pollution control measures [VOCAB] healthier living conditions for communities.",
                "Sustainable practices [VOCAB] long-term environmental benefits.",
                "Recycling programs [VOCAB] waste reduction and resource conservation.",
                "Green technologies [VOCAB] environmental impact while maintaining productivity.",
                "Environmental education [VOCAB] awareness about ecological issues.",
                "International cooperation is [VOCAB] to address global environmental challenges.",
                "Future generations deserve [VOCAB] and clean environments."
            ];
            
            let wordsAdded = 0;
            for (let sentence of sentences) {
                if (wordsAdded >= vocabWordsToUse) break;
                
                if (vocabArray.length > 0) {
                    const randomVocab = vocabArray[Math.floor(Math.random() * vocabArray.length)];
                    sentence = sentence.replace('[VOCAB]', randomVocab);
                    wordsAdded++;
                } else {
                    sentence = sentence.replace('[VOCAB]', 'require');
                }
                
                article += sentence + " ";
                if (article.split(' ').length >= targetWords) break;
            }
            
            while (article.split(' ').length < targetWords) {
                article += "Environmental stewardship ensures a sustainable future for all. ";
            }
            
            return article.trim();
        }

        function generateHealthArticle(targetWords, vocabWordsToUse) {
            const vocabArray = Array.from(extractedWords);
            let article = "Health and wellness are fundamental to quality of life. ";
            
            const sentences = [
                "Regular exercise [VOCAB] physical fitness and mental well-being.",
                "Nutritious diets [VOCAB] essential nutrients for optimal health.",
                "Medical research [VOCAB] new treatments and preventive measures.",
                "Healthcare systems must [VOCAB] accessible services for all populations.",
                "Preventive care [VOCAB] the risk of chronic diseases.",
                "Mental health support [VOCAB] comprehensive wellness programs.",
                "Public health initiatives [VOCAB] community health outcomes.",
                "Health education [VOCAB] individuals to make informed choices.",
                "Technology [VOCAB] healthcare delivery and patient monitoring.",
                "Wellness programs [VOCAB] workplace productivity and employee satisfaction."
            ];
            
            let wordsAdded = 0;
            for (let sentence of sentences) {
                if (wordsAdded >= vocabWordsToUse) break;
                
                if (vocabArray.length > 0) {
                    const randomVocab = vocabArray[Math.floor(Math.random() * vocabArray.length)];
                    sentence = sentence.replace('[VOCAB]', randomVocab);
                    wordsAdded++;
                } else {
                    sentence = sentence.replace('[VOCAB]', 'improve');
                }
                
                article += sentence + " ";
                if (article.split(' ').length >= targetWords) break;
            }
            
            while (article.split(' ').length < targetWords) {
                article += "Healthy living practices contribute to overall life satisfaction. ";
            }
            
            return article.trim();
        }

        function generateBusinessArticle(targetWords, vocabWordsToUse) {
            const vocabArray = Array.from(extractedWords);
            let article = "Modern businesses face complex challenges in today's global economy. ";
            
            const sentences = [
                "Strategic planning [VOCAB] competitive advantages in the marketplace.",
                "Innovation [VOCAB] business growth and market expansion.",
                "Customer satisfaction [VOCAB] long-term business success.",
                "Digital transformation [VOCAB] operational efficiency and productivity.",
                "Leadership skills [VOCAB] effective team management and performance.",
                "Market analysis [VOCAB] informed business decisions.",
                "Financial management [VOCAB] sustainable business operations.",
                "Brand development [VOCAB] customer loyalty and recognition.",
                "Supply chain optimization [VOCAB] cost reduction and quality improvement.",
                "Corporate responsibility [VOCAB] positive social and environmental impact."
            ];
            
            let wordsAdded = 0;
            for (let sentence of sentences) {
                if (wordsAdded >= vocabWordsToUse) break;
                
                if (vocabArray.length > 0) {
                    const randomVocab = vocabArray[Math.floor(Math.random() * vocabArray.length)];
                    sentence = sentence.replace('[VOCAB]', randomVocab);
                    wordsAdded++;
                } else {
                    sentence = sentence.replace('[VOCAB]', 'create');
                }
                
                article += sentence + " ";
                if (article.split(' ').length >= targetWords) break;
            }
            
            while (article.split(' ').length < targetWords) {
                article += "Business excellence requires continuous adaptation and improvement. ";
            }
            
            return article.trim();
        }

        function generateCultureArticle(targetWords, vocabWordsToUse) {
            const vocabArray = Array.from(extractedWords);
            let article = "Cultural diversity enriches society and promotes understanding. ";
            
            const sentences = [
                "Traditional practices [VOCAB] cultural heritage and identity.",
                "Art and literature [VOCAB] human experiences and emotions.",
                "Cultural exchange [VOCAB] mutual respect and tolerance.",
                "Language preservation [VOCAB] cultural continuity.",
                "Festivals and celebrations [VOCAB] community bonds and traditions.",
                "Cultural education [VOCAB] appreciation for diversity.",
                "Museums and galleries [VOCAB] cultural artifacts and history.",
                "Cross-cultural communication [VOCAB] global cooperation.",
                "Cultural values [VOCAB] social behavior and norms.",
                "Multicultural societies [VOCAB] innovation and creativity."
            ];
            
            let wordsAdded = 0;
            for (let sentence of sentences) {
                if (wordsAdded >= vocabWordsToUse) break;
                
                if (vocabArray.length > 0) {
                    const randomVocab = vocabArray[Math.floor(Math.random() * vocabArray.length)];
                    sentence = sentence.replace('[VOCAB]', randomVocab);
                    wordsAdded++;
                } else {
                    sentence = sentence.replace('[VOCAB]', 'preserve');
                }
                
                article += sentence + " ";
                if (article.split(' ').length >= targetWords) break;
            }
            
            while (article.split(' ').length < targetWords) {
                article += "Cultural understanding promotes peaceful coexistence. ";
            }
            
            return article.trim();
        }

        function generateScienceArticle(targetWords, vocabWordsToUse) {
            const vocabArray = Array.from(extractedWords);
            let article = "Scientific research drives human knowledge and progress. ";
            
            const sentences = [
                "Experimental methods [VOCAB] reliable and valid results.",
                "Scientific discoveries [VOCAB] our understanding of the universe.",
                "Research collaboration [VOCAB] interdisciplinary approaches to complex problems.",
                "Data analysis [VOCAB] meaningful patterns and insights.",
                "Scientific literacy [VOCAB] informed decision-making in society.",
                "Innovation in research [VOCAB] technological breakthroughs.",
                "Evidence-based conclusions [VOCAB] scientific credibility.",
                "Peer review processes [VOCAB] research quality and accuracy.",
                "Scientific communication [VOCAB] knowledge dissemination.",
                "Future research [VOCAB] solutions to global challenges."
            ];
            
            let wordsAdded = 0;
            for (let sentence of sentences) {
                if (wordsAdded >= vocabWordsToUse) break;
                
                if (vocabArray.length > 0) {
                    const randomVocab = vocabArray[Math.floor(Math.random() * vocabArray.length)];
                    sentence = sentence.replace('[VOCAB]', randomVocab);
                    wordsAdded++;
                } else {
                    sentence = sentence.replace('[VOCAB]', 'produce');
                }
                
                article += sentence + " ";
                if (article.split(' ').length >= targetWords) break;
            }
            
            while (article.split(' ').length < targetWords) {
                article += "Scientific advancement benefits humanity in countless ways. ";
            }
            
            return article.trim();
        }

        function generateGeneralArticle(targetWords, vocabWordsToUse) {
            const vocabArray = Array.from(extractedWords);
            let article = "In today's interconnected world, many factors influence our daily lives. ";
            
            const sentences = [
                "Global developments [VOCAB] local communities and individuals.",
                "Social changes [VOCAB] new opportunities and challenges.",
                "Economic factors [VOCAB] personal and professional decisions.",
                "Communication technologies [VOCAB] how people interact and share information.",
                "Educational opportunities [VOCAB] personal growth and development.",
                "Environmental conditions [VOCAB] quality of life and well-being.",
                "Cultural differences [VOCAB] diverse perspectives and approaches.",
                "Political decisions [VOCAB] social policies and regulations.",
                "Technological advances [VOCAB] workplace dynamics and skills requirements.",
                "Future trends [VOCAB] planning and preparation strategies."
            ];
            
            let wordsAdded = 0;
            for (let sentence of sentences) {
                if (wordsAdded >= vocabWordsToUse) break;
                
                if (vocabArray.length > 0) {
                    const randomVocab = vocabArray[Math.floor(Math.random() * vocabArray.length)];
                    sentence = sentence.replace('[VOCAB]', randomVocab);
                    wordsAdded++;
                } else {
                    sentence = sentence.replace('[VOCAB]', 'influence');
                }
                
                article += sentence + " ";
                if (article.split(' ').length >= targetWords) break;
            }
            
            while (article.split(' ').length < targetWords) {
                article += "Understanding these connections helps navigate modern complexities. ";
            }
            
            return article.trim();
        }

        function countVocabularyWordsInText(text) {
            const words = text.toLowerCase().replace(/[^\w\s]/g, ' ').split(/\s+/);
            let count = 0;
            
            words.forEach(word => {
                if (extractedWords.has(word)) {
                    count++;
                }
            });
            
            return count;
        }

        function copyGeneratedArticle() {
            const text = document.getElementById('generatedArticle').textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    const button = document.getElementById('copyGeneratedArticle');
                    const originalText = button.textContent;
                    button.textContent = '‚úÖ Copied!';
                    button.classList.add('bg-green-600');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-600');
                    }, 2000);
                });
            }
        }

        function downloadGeneratedArticle() {
            const text = document.getElementById('generatedArticle').textContent;
            const topic = document.getElementById('articleTopic').value;
            const currentDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`Generated Article - ${topic.charAt(0).toUpperCase() + topic.slice(1)}`, 105, 25, { align: 'center' });
                
                // Date
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated on: ${currentDate}`, 105, 35, { align: 'center' });
                
                // Line separator
                doc.line(20, 45, 190, 45);
                
                // Content
                doc.setFontSize(11);
                const splitText = doc.splitTextToSize(text, 170);
                doc.text(splitText, 20, 55);
                
                // Save
                doc.save(`Generated_Article_${topic}_${currentDate}.pdf`);
                
                const button = document.getElementById('downloadGeneratedArticle');
                const originalText = button.textContent;
                button.textContent = '‚úÖ Downloaded!';
                button.classList.add('bg-green-600');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF. Please try again.');
            }
        }

        // Practice Functions
        function showPracticeMenu() {
            // Hide exercise area and results
            document.getElementById('practiceExerciseArea').classList.add('hidden');
            document.getElementById('practiceResults').classList.add('hidden');
            
            // Show practice type selection
            document.querySelector('#practicePage .bg-gray-50:nth-child(2)').classList.remove('hidden');
        }

        function startPractice(practiceType) {
            if (extractedWords.size === 0) {
                alert('Please extract vocabulary words first from the Main page.');
                return;
            }
            
            currentPracticeType = practiceType;
            currentQuestionIndex = 0;
            practiceAnswers = [];
            practiceScore = 0;
            
            // Generate questions based on practice type
            switch (practiceType) {
                case 'fillBlank':
                    generateFillBlankQuestions();
                    document.getElementById('practiceTitle').textContent = 'Fill in the Blanks';
                    break;
                case 'matching':
                    generateMatchingQuestions();
                    document.getElementById('practiceTitle').textContent = 'Word Matching';
                    break;
                case 'multipleChoice':
                    generateMultipleChoiceQuestions();
                    document.getElementById('practiceTitle').textContent = 'Multiple Choice';
                    break;
            }
            
            // Hide practice type selection and show exercise area
            document.querySelector('#practicePage .bg-gray-50:nth-child(2)').classList.add('hidden');
            document.getElementById('practiceExerciseArea').classList.remove('hidden');
            
            showCurrentQuestion();
        }

        function generateFillBlankQuestions() {
            // Randomly select 10 words from available vocabulary
            const vocabArray = Array.from(extractedWords);
            const selectedWords = [];
            const usedIndices = new Set();
            
            // Randomly select up to 10 unique words
            while (selectedWords.length < Math.min(10, vocabArray.length)) {
                const randomIndex = Math.floor(Math.random() * vocabArray.length);
                if (!usedIndices.has(randomIndex)) {
                    selectedWords.push(vocabArray[randomIndex]);
                    usedIndices.add(randomIndex);
                }
            }
            
            practiceQuestions = [];
            
            // Multiple sentence template pools to choose from
            const sentenceTemplatePools = [
                [
                    "The research team will _______ a comprehensive study on this topic.",
                    "Students need to _______ their knowledge through practical application.",
                    "The company decided to _______ new policies to improve efficiency.",
                    "Scientists _______ that climate change requires immediate action.",
                    "The government will _______ funding for educational programs.",
                    "Teachers must _______ innovative methods to engage students.",
                    "The project aims to _______ sustainable solutions for the community.",
                    "Experts _______ that technology will transform the industry.",
                    "The organization plans to _______ international partnerships.",
                    "Researchers will _______ the data to identify patterns."
                ],
                [
                    "The committee decided to _______ the proposal for further review.",
                    "Students should _______ their understanding through regular practice.",
                    "The new system will _______ efficiency across all departments.",
                    "Researchers _______ that this approach yields better results.",
                    "The institution plans to _______ additional resources for the program.",
                    "Educators must _______ creative strategies to engage learners.",
                    "This initiative seeks to _______ positive change in the community.",
                    "Analysts _______ that market trends will continue to evolve.",
                    "The team hopes to _______ stronger collaboration with partners.",
                    "Scientists will _______ the findings to support their hypothesis."
                ],
                [
                    "The board will _______ a new strategy for growth.",
                    "Participants need to _______ their skills in practical settings.",
                    "The organization chose to _______ innovative approaches.",
                    "Experts _______ that technology adoption is crucial.",
                    "The university will _______ scholarships for deserving students.",
                    "Instructors should _______ diverse teaching methods.",
                    "The program intends to _______ sustainable development goals.",
                    "Studies _______ that early intervention is most effective.",
                    "The company seeks to _______ global partnerships.",
                    "Investigators will _______ evidence to build their case."
                ],
                [
                    "The administration plans to _______ comprehensive reforms.",
                    "Learners must _______ theoretical knowledge with practice.",
                    "The department will _______ updated procedures soon.",
                    "Research _______ that this method produces reliable outcomes.",
                    "The foundation aims to _______ support for educational initiatives.",
                    "Facilitators need to _______ engaging learning experiences.",
                    "This effort strives to _______ meaningful social impact.",
                    "Evidence _______ that collaboration enhances productivity.",
                    "The firm intends to _______ strategic alliances.",
                    "Scholars will _______ data from multiple sources."
                ]
            ];
            
            // Randomly select a template pool
            const selectedPool = sentenceTemplatePools[Math.floor(Math.random() * sentenceTemplatePools.length)];
            
            // Shuffle the selected pool to randomize order
            const shuffledTemplates = [...selectedPool].sort(() => Math.random() - 0.5);
            
            selectedWords.forEach((word, index) => {
                if (index < shuffledTemplates.length) {
                    practiceQuestions.push({
                        type: 'fillBlank',
                        sentence: shuffledTemplates[index],
                        correctAnswer: word,
                        userAnswer: null
                    });
                }
            });
            
            console.log(`Generated ${practiceQuestions.length} new fill-in-the-blank questions`);
            document.getElementById('totalQuestions').textContent = practiceQuestions.length;
        }

        function generateMatchingQuestions() {
            // Randomly select 8 words from available vocabulary
            const vocabArray = Array.from(extractedWords);
            const selectedWords = [];
            const usedIndices = new Set();
            
            // Randomly select up to 8 unique words
            while (selectedWords.length < Math.min(8, vocabArray.length)) {
                const randomIndex = Math.floor(Math.random() * vocabArray.length);
                if (!usedIndices.has(randomIndex)) {
                    selectedWords.push(vocabArray[randomIndex]);
                    usedIndices.add(randomIndex);
                }
            }
            
            practiceQuestions = [];
            
            // Comprehensive dictionary-style definitions database
            const dictionaryDefinitions = {
                // Academic and formal words
                'establish': 'to set up (an organization, system, or set of rules) on a firm or permanent basis',
                'demonstrate': 'to clearly show the existence or truth of something by giving proof or evidence',
                'significant': 'sufficiently great or important to be worthy of attention; noteworthy',
                'comprehensive': 'complete and including everything that is necessary; covering all aspects',
                'essential': 'absolutely necessary; extremely important for a particular purpose',
                'facilitate': 'to make an action or process easier or help bring about',
                'innovative': 'featuring new methods; advanced and original in thinking',
                'substantial': 'of considerable importance, size, or worth; large in amount',
                'fundamental': 'forming a necessary base or core; of central importance',
                'evident': 'clearly seen or understood; obvious to the eye or mind',
                'prominent': 'important; famous; standing out so as to be clearly visible',
                'adequate': 'satisfactory or acceptable in quality or quantity; sufficient',
                'substantial': 'of considerable importance, size, or worth; solidly built',
                'appropriate': 'suitable or proper in the circumstances; fitting',
                'consistent': 'acting or done in the same way over time; unchanging in achievement',
                'considerable': 'notably large in size, amount, or extent; substantial',
                'contemporary': 'belonging to or occurring in the present time; modern',
                'crucial': 'decisive or critical, especially in the success or failure of something',
                'diverse': 'showing a great deal of variety; very different from each other',
                'efficient': 'achieving maximum productivity with minimum wasted effort or expense',
                'extensive': 'covering or affecting a large area; having a wide scope or range',
                'inevitable': 'certain to happen; unavoidable as a natural consequence',
                'legitimate': 'conforming to the law or to rules; able to be defended with logic',
                'obvious': 'easily perceived or understood; clear, self-evident, or apparent',
                'potential': 'having or showing the capacity to develop into something in the future',
                'sufficient': 'enough; adequate for the purpose intended or required',
                'technique': 'a way of carrying out a particular activity requiring special skill',
                'ultimate': 'being or happening at the end of a process; final or eventual',
                'accurate': 'correct in all details; exact and without error',
                'beneficial': 'resulting in good; favorable or advantageous; helpful',
                'complex': 'consisting of many different and connected parts; complicated',
                'distinct': 'recognizably different in nature; physically separate and individual',
                'enhance': 'to intensify, increase, or further improve the quality or value of',
                'implement': 'to put a decision or plan into effect; to carry out or accomplish',
                'indicate': 'to point out or show; to be a sign or symptom of something',
                'objective': 'not influenced by personal feelings; based on facts rather than emotions',
                'profound': 'very great or intense; having deep insight or understanding',
                'relevant': 'closely connected or appropriate to what is being done or considered',
                'specific': 'clearly defined or identified; precise and clearly expressed',
                'tradition': 'the transmission of customs or beliefs from generation to generation',
                'analyze': 'to examine methodically and in detail to explain and interpret',
                'category': 'a class or division of people or things having particular shared characteristics',
                'concept': 'an abstract idea; a general notion or understanding',
                'conduct': 'to organize and carry out; to lead or guide someone or something',
                'consequence': 'a result or effect of an action or condition; something that follows',
                'construct': 'to build or erect something; to form an idea or theory by combining elements',
                'contrast': 'the state of being strikingly different from something else in comparison',
                'contribute': 'to give something in order to help achieve or provide something',
                'criterion': 'a principle or standard by which something may be judged or decided',
                'dimension': 'a measurable extent of some kind; an aspect or feature of a situation',
                'element': 'a component or constituent part of a whole; a basic building block',
                'evaluate': 'to form an idea of the amount, number, or value of; to assess',
                'function': 'an activity or purpose natural to or intended for a person or thing',
                'generate': 'to cause something to arise or come about; to produce or create',
                'hypothesis': 'a supposition or proposed explanation made on the basis of limited evidence',
                'individual': 'single; separate; relating to one person rather than a group',
                'maintain': 'to cause or enable a condition or state of affairs to continue',
                'method': 'a particular form of procedure for accomplishing or approaching something',
                'participate': 'to take part in; to be involved in an activity or event',
                'principle': 'a fundamental truth or proposition serving as the foundation for belief',
                'procedure': 'an established or official way of doing something; a series of actions',
                'process': 'a series of actions or steps taken to achieve a particular end',
                'require': 'to need for a particular purpose; to demand as necessary or essential',
                'respond': 'to say something in reply; to react quickly or positively to',
                'structure': 'the arrangement of and relations between parts or elements of something',
                'theory': 'a supposition or system of ideas intended to explain something',
                'transfer': 'to move from one place to another; to convey or shift something',
                'variable': 'an element, feature, or factor liable to vary or change',
                
                // Business and professional terms
                'achieve': 'to successfully bring about or reach a desired objective or result',
                'acquire': 'to buy or obtain an asset or object for oneself; to gain possession of',
                'approach': 'a way of dealing with something; to come near or nearer to',
                'authority': 'the power or right to give orders and enforce obedience',
                'available': 'able to be used or obtained; at someone\'s disposal',
                'benefit': 'an advantage or profit gained from something; a helpful result',
                'commission': 'an instruction, command, or duty given to a person or group',
                'communicate': 'to convey or share ideas, information, or feelings effectively',
                'community': 'a group of people living in the same place or having characteristics in common',
                'compute': 'to calculate or reckon a figure or amount using mathematics',
                'conclude': 'to bring something to an end; to arrive at a judgment by reasoning',
                'consumer': 'a person who purchases goods and services for personal use',
                'contact': 'physical touching; communication or meeting with someone',
                'create': 'to bring something into existence; to cause something to happen',
                'data': 'facts and statistics collected together for reference or analysis',
                'define': 'to state or describe exactly the nature, scope, or meaning of',
                'derive': 'to obtain something from a specified source; to base a conclusion on',
                'distribute': 'to give shares of something to a number of recipients',
                'economy': 'the wealth and resources of a country or region in terms of production',
                'environment': 'the surroundings or conditions in which a person operates',
                'estimate': 'to roughly calculate or judge the value, number, quantity, or extent of',
                'factor': 'a circumstance, fact, or influence that contributes to a result',
                'finance': 'the management of large amounts of money by governments or large companies',
                'formula': 'a mathematical relationship or rule expressed in symbols',
                'identify': 'to recognize or establish who or what someone or something is',
                'income': 'money received, especially on a regular basis, for work or investments',
                'interpret': 'to explain the meaning of information or actions; to translate',
                'invest': 'to put money into financial schemes with the expectation of achieving profit',
                'issue': 'an important topic or problem for debate or discussion; to supply',
                'labor': 'work involving mental or physical effort done to achieve a purpose',
                'major': 'important, serious, or significant; greater in size, extent, or intensity',
                'obtain': 'to get, acquire, or secure something; to succeed in achieving',
                'occur': 'to happen; to take place; to be found or encountered',
                'period': 'a length or portion of time; an interval between events',
                'policy': 'a course or principle of action adopted by a government or organization',
                'previous': 'existing or occurring before in time or order; former or earlier',
                'primary': 'of chief importance; principal; first in order of importance',
                'purchase': 'to acquire something by paying for it; to buy goods or services',
                'range': 'the area of variation between upper and lower limits; a variety',
                'region': 'an area or division having definable characteristics but not fixed boundaries',
                'register': 'to record formally and officially; to become aware of something',
                'regulation': 'a rule or directive made and maintained by an authority',
                'relate': 'to have connection, association, or reference to something',
                'remove': 'to take something away or off; to eliminate or get rid of',
                'resource': 'a stock or supply of money, materials, or other assets',
                'restrict': 'to put a limit on; to keep under control; to constrain',
                'secure': 'to fix or attach something firmly; to obtain or achieve something',
                'select': 'to carefully choose as being the best or most suitable',
                'source': 'a place, person, or thing from which something comes or can be obtained',
                'strategy': 'a plan of action designed to achieve a long-term or overall aim',
                'target': 'a person, object, or place selected as the aim of an attack or operation',
                'technology': 'the application of scientific knowledge for practical purposes',
                'volume': 'the amount of space that a substance or object occupies',
                
                // Educational and academic terms
                'academic': 'relating to education and scholarship; scholarly in approach',
                'access': 'the means of approaching or entering a place; the right to use something',
                'circumstance': 'a fact or condition connected with an event or action',
                'civil': 'relating to citizens and their concerns; courteous and polite',
                'cultural': 'relating to the arts, customs, and achievements of a particular society',
                'development': 'the process of developing or being developed; growth or advancement',
                'domestic': 'relating to the running of a home or family; within one country',
                'economic': 'relating to economics or the economy; profitable or cost-effective',
                'ethnic': 'relating to a population subgroup with common national or cultural tradition',
                'export': 'to send goods or services to another country for sale',
                'federal': 'relating to a system of government where power is divided between central and local',
                'global': 'relating to the whole world; worldwide in scope or application',
                'legal': 'relating to the law; permitted by law; conforming to rules',
                'local': 'relating to a particular area or neighborhood rather than the whole country',
                'mental': 'relating to the mind; carried out by the mind rather than physically',
                'national': 'relating to a nation as a whole; common to a whole nation',
                'negative': 'expressing denial, disagreement, or refusal; lacking positive features',
                'physical': 'relating to the body; relating to things perceived through the senses',
                'political': 'relating to government or public affairs; having a definite policy',
                'positive': 'consisting in or characterized by the presence of features; constructive',
                'professional': 'relating to a job requiring special education or training',
                'public': 'relating to ordinary people in general; done for the community',
                'research': 'the systematic investigation into materials to establish facts',
                'similar': 'resembling without being identical; having characteristics in common',
                'social': 'relating to society or its organization; needing companionship',
                'special': 'better, greater, or otherwise different from what is usual',
                'standard': 'used or accepted as normal or average; a level of quality',
                'support': 'to bear all or part of the weight; to give assistance to',
                'total': 'comprising the whole number or amount; complete and absolute',
                'traditional': 'existing in or as part of a tradition; long-established',
                'union': 'the action of joining or combining things together; a united group'
            };
            
            // Generate matching questions with real definitions
            const questions = selectedWords.map(word => ({
                type: 'matching',
                word: word,
                definition: dictionaryDefinitions[word] || generateFallbackDefinition(word),
                matched: false
            }));
            
            practiceQuestions = [{
                type: 'matching',
                items: questions,
                userMatches: {},
                completed: false
            }];
            
            console.log(`Generated matching exercise with ${selectedWords.length} vocabulary words`);
            document.getElementById('totalQuestions').textContent = 1;
        }
        
        function generateFallbackDefinition(word) {
            // Generate more sophisticated fallback definitions based on word patterns
            if (word.endsWith('tion') || word.endsWith('sion')) {
                return `the action or process of ${word.slice(0, -4)}ing; the state of being ${word.slice(0, -4)}ed`;
            } else if (word.endsWith('ment')) {
                return `the action or result of ${word.slice(0, -4)}ing; a means of achieving something`;
            } else if (word.endsWith('ness')) {
                return `the quality or state of being ${word.slice(0, -4)}; the condition of having this characteristic`;
            } else if (word.endsWith('able') || word.endsWith('ible')) {
                return `capable of being ${word.slice(0, -4)}ed; having the quality that makes this possible`;
            } else if (word.endsWith('ly')) {
                return `in a manner that is ${word.slice(0, -2)}; characterized by this quality`;
            } else if (word.endsWith('ive')) {
                return `having the nature of ${word.slice(0, -3)}ing; tending to produce this effect`;
            } else if (word.endsWith('ous')) {
                return `characterized by or full of ${word.slice(0, -3)}; having this particular quality`;
            } else if (word.endsWith('ing')) {
                return `the action of performing or carrying out this activity; the process of doing this`;
            } else if (word.endsWith('ed')) {
                return `having been subject to this action; showing the effects of this process`;
            } else {
                // For other words, create a more academic definition
                return `a term used in academic and professional contexts relating to ${word}; characterized by properties associated with this concept`;
            }
        }

        function generateMultipleChoiceQuestions() {
            const vocabArray = Array.from(extractedWords).slice(0, 10);
            practiceQuestions = [];
            
            const contexts = [
                "The study will _______ important findings about student learning.",
                "The new policy aims to _______ educational opportunities.",
                "Researchers must _______ their methodology carefully.",
                "The program helps _______ student academic performance.",
                "Teachers need to _______ effective learning strategies.",
                "The project will _______ community development initiatives.",
                "Scientists plan to _______ the experimental results thoroughly.",
                "The organization seeks to _______ international cooperation.",
                "Experts recommend _______ sustainable practices.",
                "The committee will _______ the proposal next week."
            ];
            
            vocabArray.forEach((correctWord, index) => {
                if (index < contexts.length) {
                    // Create distractors (incorrect options)
                    const otherWords = vocabArray.filter(w => w !== correctWord);
                    const distractors = [];
                    
                    for (let i = 0; i < 3 && i < otherWords.length; i++) {
                        distractors.push(otherWords[i]);
                    }
                    
                    // If not enough vocabulary words, add common words
                    while (distractors.length < 3) {
                        const commonWords = ['make', 'show', 'help', 'find', 'give', 'take', 'work', 'know'];
                        const randomCommon = commonWords[Math.floor(Math.random() * commonWords.length)];
                        if (!distractors.includes(randomCommon) && randomCommon !== correctWord) {
                            distractors.push(randomCommon);
                        }
                    }
                    
                    // Shuffle options
                    const options = [correctWord, ...distractors.slice(0, 3)];
                    for (let i = options.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [options[i], options[j]] = [options[j], options[i]];
                    }
                    
                    practiceQuestions.push({
                        type: 'multipleChoice',
                        context: contexts[index],
                        options: options,
                        correctAnswer: correctWord,
                        userAnswer: null
                    });
                }
            });
            
            document.getElementById('totalQuestions').textContent = practiceQuestions.length;
        }

        function showCurrentQuestion() {
            const question = practiceQuestions[currentQuestionIndex];
            const content = document.getElementById('practiceContent');
            
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            
            if (question.type === 'fillBlank') {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg">${question.sentence}</p>
                        <input type="text" id="fillBlankAnswer" placeholder="Type your answer here..." 
                               class="text-base w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                    </div>
                `;
                
                // Restore previous answer if any
                if (question.userAnswer) {
                    document.getElementById('fillBlankAnswer').value = question.userAnswer;
                }
                
            } else if (question.type === 'multipleChoice') {
                const optionsHTML = question.options.map((option, index) => `
                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                        <input type="radio" name="mcOption" value="${option}" class="mr-3">
                        <span>${option}</span>
                    </label>
                `).join('');
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg">${question.context}</p>
                        <div class="space-y-2">
                            ${optionsHTML}
                        </div>
                    </div>
                `;
                
                // Restore previous answer if any
                if (question.userAnswer) {
                    const radio = document.querySelector(`input[value="${question.userAnswer}"]`);
                    if (radio) radio.checked = true;
                }
                
            } else if (question.type === 'matching') {
                const wordsHTML = question.items.map((item, index) => `
                    <div class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-blue-50 dark:bg-blue-900 cursor-pointer" 
                         data-word="${item.word}" data-type="word">
                        ${item.word}
                    </div>
                `).join('');
                
                const defsHTML = question.items.map((item, index) => `
                    <div class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-green-50 dark:bg-green-900 cursor-pointer" 
                         data-definition="${item.definition}" data-word="${item.word}" data-type="definition">
                        ${item.definition}
                    </div>
                `).join('');
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg">Match each word with its correct definition:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <h4 class="font-semibold">Words:</h4>
                                ${wordsHTML}
                            </div>
                            <div class="space-y-2">
                                <h4 class="font-semibold">Definitions:</h4>
                                ${defsHTML}
                            </div>
                        </div>
                        <div id="matchingFeedback" class="text-sm text-gray-600 dark:text-gray-400">
                            Click on a word, then click on its matching definition.
                        </div>
                    </div>
                `;
                
                // Add matching functionality
                setupMatchingInteraction();
            }
            
            // Update navigation buttons
            document.getElementById('prevQuestion').style.display = currentQuestionIndex === 0 ? 'none' : 'inline-block';
            document.getElementById('nextQuestion').style.display = currentQuestionIndex === practiceQuestions.length - 1 ? 'none' : 'inline-block';
            document.getElementById('finishPractice').style.display = currentQuestionIndex === practiceQuestions.length - 1 ? 'inline-block' : 'none';
        }

        let selectedWord = null;

        function setupMatchingInteraction() {
            const wordElements = document.querySelectorAll('[data-type="word"]');
            const defElements = document.querySelectorAll('[data-type="definition"]');
            
            wordElements.forEach(el => {
                el.addEventListener('click', () => {
                    // Remove previous selection
                    wordElements.forEach(w => w.classList.remove('ring-2', 'ring-blue-500'));
                    
                    // Select this word
                    el.classList.add('ring-2', 'ring-blue-500');
                    selectedWord = el.dataset.word;
                    
                    document.getElementById('matchingFeedback').textContent = `Selected: ${selectedWord}. Now click on its definition.`;
                });
            });
            
            defElements.forEach(el => {
                el.addEventListener('click', () => {
                    if (!selectedWord) {
                        document.getElementById('matchingFeedback').textContent = 'Please select a word first.';
                        return;
                    }
                    
                    const question = practiceQuestions[currentQuestionIndex];
                    question.userMatches[selectedWord] = el.dataset.definition;
                    
                    // Visual feedback
                    if (selectedWord === el.dataset.word) {
                        el.classList.add('bg-green-200', 'dark:bg-green-800');
                        document.querySelector(`[data-word="${selectedWord}"][data-type="word"]`).classList.add('bg-green-200', 'dark:bg-green-800');
                        document.getElementById('matchingFeedback').textContent = `Correct match! ${selectedWord} matched with its definition.`;
                    } else {
                        el.classList.add('bg-red-200', 'dark:bg-red-800');
                        document.getElementById('matchingFeedback').textContent = `${selectedWord} matched with selected definition. Continue matching.`;
                    }
                    
                    // Reset selection
                    selectedWord = null;
                    document.querySelectorAll('[data-type="word"]').forEach(w => w.classList.remove('ring-2', 'ring-blue-500'));
                    
                    // Check if all matched
                    if (Object.keys(question.userMatches).length === question.items.length) {
                        question.completed = true;
                        document.getElementById('matchingFeedback').textContent = 'All words matched! Click Next or Finish to continue.';
                    }
                });
            });
        }

        function saveCurrentAnswer() {
            const question = practiceQuestions[currentQuestionIndex];
            
            if (question.type === 'fillBlank') {
                const answer = document.getElementById('fillBlankAnswer').value.trim();
                question.userAnswer = answer;
            } else if (question.type === 'multipleChoice') {
                const selected = document.querySelector('input[name="mcOption"]:checked');
                question.userAnswer = selected ? selected.value : null;
            }
            // Matching answers are saved in real-time
        }

        function previousQuestion() {
            saveCurrentAnswer();
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showCurrentQuestion();
            }
        }

        function nextQuestion() {
            saveCurrentAnswer();
            if (currentQuestionIndex < practiceQuestions.length - 1) {
                currentQuestionIndex++;
                showCurrentQuestion();
            }
        }

        function finishPractice() {
            saveCurrentAnswer();
            calculateScore();
            showResults();
        }

        function calculateScore() {
            let correct = 0;
            
            practiceQuestions.forEach(question => {
                if (question.type === 'fillBlank' || question.type === 'multipleChoice') {
                    if (question.userAnswer && question.userAnswer.toLowerCase() === question.correctAnswer.toLowerCase()) {
                        correct++;
                    }
                } else if (question.type === 'matching') {
                    let matchingCorrect = 0;
                    question.items.forEach(item => {
                        if (question.userMatches[item.word] === item.definition) {
                            matchingCorrect++;
                        }
                    });
                    correct += matchingCorrect / question.items.length; // Proportional scoring for matching
                }
            });
            
            practiceScore = correct;
        }

        function showResults() {
            document.getElementById('practiceExerciseArea').classList.add('hidden');
            document.getElementById('practiceResults').classList.remove('hidden');
            
            const percentage = Math.round((practiceScore / practiceQuestions.length) * 100);
            const scoreColor = percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600';
            
            let resultsHTML = `
                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">
                        ${percentage >= 70 ? 'üéâ' : percentage >= 50 ? 'üëç' : 'üìö'}
                    </div>
                    <h3 class="text-2xl font-bold ${scoreColor}">
                        Score: ${Math.round(practiceScore)}/${practiceQuestions.length} (${percentage}%)
                    </h3>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">
                        ${percentage >= 70 ? 'Excellent work!' : percentage >= 50 ? 'Good effort! Keep practicing.' : 'Keep studying and try again.'}
                    </p>
                </div>
                
                <div class="space-y-4">
                    <h4 class="font-semibold">Review your answers:</h4>
            `;
            
            practiceQuestions.forEach((question, index) => {
                if (question.type === 'fillBlank' || question.type === 'multipleChoice') {
                    const isCorrect = question.userAnswer && question.userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();
                    const statusIcon = isCorrect ? '‚úÖ' : '‚ùå';
                    const statusColor = isCorrect ? 'text-green-600' : 'text-red-600';
                    
                    resultsHTML += `
                        <div class="p-3 border border-gray-200 dark:border-gray-600 rounded-md">
                            <div class="flex items-start space-x-2">
                                <span class="text-lg">${statusIcon}</span>
                                <div class="flex-1">
                                    <p class="font-medium">Question ${index + 1}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        Your answer: <span class="${statusColor}">${question.userAnswer || 'No answer'}</span>
                                    </p>
                                    ${!isCorrect ? `<p class="text-sm text-green-600">Correct answer: ${question.correctAnswer}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            resultsHTML += '</div>';
            
            document.getElementById('resultsContent').innerHTML = resultsHTML;
        }

        function restartCurrentPractice() {
            startPractice(currentPracticeType);
        }

        function backToPracticeMenu() {
            showPracticeMenu();
        }

        // Drag and Drop functionality
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            const dropZone = document.getElementById('dropZone');
            dropZone.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        }

        function unhighlight(e) {
            const dropZone = document.getElementById('dropZone');
            dropZone.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            console.log(`${files.length} files dropped`);
            handleMultipleFiles([...files]);
        }

        function handleMultipleFileUpload(event) {
            const files = [...event.target.files];
            console.log(`${files.length} files selected`);
            handleMultipleFiles(files);
        }

        async function handleMultipleFiles(files) {
            if (files.length === 0) return;
            
            // Filter valid files
            const validFiles = files.filter(file => {
                const fileName = file.name.toLowerCase();
                return fileName.endsWith('.pdf') || fileName.endsWith('.docx');
            });
            
            if (validFiles.length === 0) {
                alert('Please upload PDF or DOCX files only.');
                return;
            }
            
            if (validFiles.length !== files.length) {
                const invalidCount = files.length - validFiles.length;
                alert(`${invalidCount} file(s) were skipped. Only PDF and DOCX files are supported.`);
            }
            
            // Initialize UI for multiple file processing
            fileQueue = validFiles;
            currentFileIndex = 0;
            
            // Show progress UI
            document.getElementById('extractionProgress').classList.remove('hidden');
            document.getElementById('fileList').classList.remove('hidden');
            
            // Update progress details
            document.getElementById('progressDetails').textContent = `File 0 of ${validFiles.length}`;
            document.getElementById('progressBar').style.width = '0%';
            
            // Display file queue
            displayFileQueue(validFiles);
            
            // Process files sequentially
            let allExtractedText = '';
            const newWords = new Set();
            const newWordFrequency = {};
            
            for (let i = 0; i < validFiles.length; i++) {
                currentFileIndex = i;
                const file = validFiles[i];
                
                try {
                    updateProgressForFile(i + 1, validFiles.length, `Processing ${file.name}...`);
                    markFileAsProcessing(i);
                    
                    const text = await processIndividualFile(file);
                    allExtractedText += text + '\n\n';
                    
                    // Store article for chatbot
                    storeArticleForChatbot(file.name, text);
                    
                    markFileAsComplete(i);
                    
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    markFileAsError(i, error.message);
                    // Continue with other files
                }
                
                // Update progress bar
                const progress = ((i + 1) / validFiles.length) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            }
            
            // Process all extracted text together
            if (allExtractedText.trim()) {
                updateProgressMessage('üîÑ Analyzing combined text and extracting vocabulary...');
                extractWordsFromText(allExtractedText);
                
                updateProgressMessage(`‚úÖ Successfully processed ${validFiles.length} files!`);
                
                // Auto-hide progress after 3 seconds
                setTimeout(() => {
                    document.getElementById('extractionProgress').classList.add('hidden');
                    document.getElementById('fileList').classList.add('hidden');
                }, 3000);
            } else {
                updateProgressMessage('‚ùå No text could be extracted from any files.');
                setTimeout(() => {
                    document.getElementById('extractionProgress').classList.add('hidden');
                    document.getElementById('fileList').classList.add('hidden');
                }, 3000);
            }
        }

        async function processIndividualFile(file) {
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.pdf')) {
                return await handlePDFExtraction(file);
            } else if (fileName.endsWith('.docx')) {
                return await handleDOCXExtraction(file);
            } else {
                throw new Error('Unsupported file type');
            }
        }

        function displayFileQueue(files) {
            const queueContainer = document.getElementById('fileQueue');
            queueContainer.innerHTML = '';
            
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center space-x-2 text-xs p-2 bg-gray-100 dark:bg-gray-700 rounded';
                fileItem.id = `file-${index}`;
                
                fileItem.innerHTML = `
                    <span class="file-icon">‚è≥</span>
                    <span class="file-name flex-1 truncate">${file.name}</span>
                    <span class="file-size text-gray-500">${formatFileSize(file.size)}</span>
                `;
                
                queueContainer.appendChild(fileItem);
            });
        }

        function updateProgressForFile(current, total, message) {
            document.getElementById('progressMessage').textContent = message;
            document.getElementById('progressDetails').textContent = `File ${current} of ${total}`;
        }

        function markFileAsProcessing(index) {
            const fileItem = document.getElementById(`file-${index}`);
            if (fileItem) {
                fileItem.querySelector('.file-icon').textContent = 'üîÑ';
                fileItem.classList.add('bg-blue-100', 'dark:bg-blue-800');
            }
        }

        function markFileAsComplete(index) {
            const fileItem = document.getElementById(`file-${index}`);
            if (fileItem) {
                fileItem.querySelector('.file-icon').textContent = '‚úÖ';
                fileItem.classList.remove('bg-blue-100', 'dark:bg-blue-800');
                fileItem.classList.add('bg-green-100', 'dark:bg-green-800');
            }
        }

        function markFileAsError(index, error) {
            const fileItem = document.getElementById(`file-${index}`);
            if (fileItem) {
                fileItem.querySelector('.file-icon').textContent = '‚ùå';
                fileItem.classList.remove('bg-blue-100', 'dark:bg-blue-800');
                fileItem.classList.add('bg-red-100', 'dark:bg-red-800');
                fileItem.title = `Error: ${error}`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Enhanced article storage for chatbot
        function storeArticleForChatbot(fileName, content) {
            const article = {
                id: Date.now() + Math.random(),
                fileName: fileName,
                content: content,
                timestamp: new Date().toISOString(),
                wordCount: content.split(/\s+/).length,
                extractedWords: Array.from(extractedWords),
                wordFrequency: {...wordFrequency}
            };
            
            storedArticles.push(article);
            
            // Keep only last 100 articles (increased from 50)
            if (storedArticles.length > 100) {
                storedArticles = storedArticles.slice(-100);
            }
            
            // Save to localStorage with error handling
            const saved = safeSaveToStorage('vocabularyArticles', storedArticles);
            
            // Also save current vocabulary state
            safeSaveToStorage('currentVocabulary', {
                words: Array.from(extractedWords),
                frequency: wordFrequency,
                wordsByPOS: wordsByPOS,
                lastUpdated: new Date().toISOString()
            });
            
            console.log(`Stored article: ${fileName} (${article.wordCount} words) - Storage: ${saved ? 'Success' : 'Memory only'}`);
            
            // Show storage status to user
            updateStorageStatus();
        }
        
        // Chat functionality
        function updateChatPageStats() {
            document.getElementById('storedArticleCount').textContent = storedArticles.length;
            document.getElementById('storedWordCount').textContent = extractedWords.size;
            
            const totalContent = storedArticles.reduce((sum, article) => sum + article.wordCount, 0);
            document.getElementById('totalContentSize').textContent = totalContent;
            
            // Update recent articles list
            updateRecentArticlesList();
        }
        
        function updateRecentArticlesList() {
            const recentContainer = document.getElementById('recentArticles');
            
            if (storedArticles.length === 0) {
                recentContainer.innerHTML = '<p class="text-sm text-gray-500">No articles stored yet</p>';
                return;
            }
            
            const recentArticles = storedArticles.slice(-5).reverse(); // Last 5, most recent first
            recentContainer.innerHTML = recentArticles.map(article => `
                <div class="text-sm p-2 bg-gray-100 dark:bg-gray-700 rounded">
                    <div class="font-medium truncate">${article.fileName}</div>
                    <div class="text-xs text-gray-500">${article.wordCount} words ‚Ä¢ ${new Date(article.timestamp).toLocaleDateString()}</div>
                </div>
            `).join('');
        }
        
        // Chat event listeners
        document.getElementById('sendMessage').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        // Quick action buttons
        document.querySelectorAll('.quick-action').forEach(button => {
            button.addEventListener('click', () => {
                const query = button.dataset.query;
                document.getElementById('chatInput').value = query;
                sendChatMessage();
            });
        });
        
        document.getElementById('exportChatHistory').addEventListener('click', exportChatHistory);
        document.getElementById('clearStoredData').addEventListener('click', clearStoredData);
        document.getElementById('shareData').addEventListener('click', shareData);
        document.getElementById('loadSharedData').addEventListener('click', loadSharedData);
        document.getElementById('exportAllData').addEventListener('click', exportAllData);
        document.getElementById('importDataFile').addEventListener('click', () => document.getElementById('importFileInput').click());
        document.getElementById('importFileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) importData(e.target.files[0]);
        });
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Process message and generate response
            setTimeout(() => {
                const response = generateChatResponse(message);
                hideTypingIndicator();
                addMessageToChat('bot', response);
            }, 1000 + Math.random() * 1000); // Simulate thinking time
        }
        
        function addMessageToChat(sender, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${sender === 'user' ? 'text-right' : 'text-left'}`;
            
            const isUser = sender === 'user';
            const bgColor = isUser ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-gray-100';
            const alignment = isUser ? 'ml-12' : 'mr-12';
            
            messageDiv.innerHTML = `
                <div class="inline-block ${bgColor} ${alignment} px-4 py-2 rounded-lg max-w-xs lg:max-w-md">
                    <div class="text-sm">${isUser ? 'üë§ You' : 'ü§ñ Assistant'}</div>
                    <div class="mt-1">${message}</div>
                    <div class="text-xs opacity-70 mt-1">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('hidden');
        }
        
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('hidden');
        }
        
        function generateChatResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Handle different types of queries
            if (lowerMessage.includes('article') && lowerMessage.includes('list')) {
                return generateArticleList();
            }
            
            if (lowerMessage.includes('vocabulary') || lowerMessage.includes('words')) {
                return generateVocabularyResponse();
            }
            
            if (lowerMessage.includes('topic') || lowerMessage.includes('subject')) {
                return generateTopicAnalysis();
            }
            
            if (lowerMessage.includes('practice') || lowerMessage.includes('help')) {
                return generatePracticeHelp();
            }
            
            if (lowerMessage.includes('statistics') || lowerMessage.includes('stats')) {
                return generateStatistics();
            }
            
            if (lowerMessage.includes('search') || lowerMessage.includes('find')) {
                return generateSearchResponse(message);
            }
            
            // Default response
            return generateDefaultResponse();
        }
        
        function generateArticleList() {
            if (storedArticles.length === 0) {
                return "üìö You haven't uploaded any articles yet. Upload some PDF or DOCX files on the Main page to get started!";
            }
            
            let response = `üìö **Your Uploaded Articles** (${storedArticles.length} total):\n\n`;
            
            storedArticles.slice(-10).reverse().forEach((article, index) => {
                const date = new Date(article.timestamp).toLocaleDateString();
                response += `${index + 1}. **${article.fileName}**\n   ‚Ä¢ ${article.wordCount} words\n   ‚Ä¢ Uploaded: ${date}\n\n`;
            });
            
            if (storedArticles.length > 10) {
                response += `... and ${storedArticles.length - 10} more articles.`;
            }
            
            return response;
        }
        
        function generateVocabularyResponse() {
            if (extractedWords.size === 0) {
                return "üî§ No vocabulary words extracted yet. Upload some documents on the Main page to build your word list!";
            }
            
            let response = `üî§ **Your Vocabulary Collection** (${extractedWords.size} words):\n\n`;
            
            // Show distribution by part of speech
            Object.entries(wordsByPOS).forEach(([pos, words]) => {
                const count = Object.keys(words).length;
                if (count > 0) {
                    response += `**${pos}**: ${count} words\n`;
                }
            });
            
            response += '\n**Most Frequent Words**:\n';
            const topWords = Array.from(extractedWords)
                .map(word => ({ word, freq: wordFrequency[word] || 1 }))
                .sort((a, b) => b.freq - a.freq)
                .slice(0, 10);
            
            topWords.forEach((item, index) => {
                response += `${index + 1}. ${item.word} (${item.freq}x)\n`;
            });
            
            return response;
        }
        
        function generateTopicAnalysis() {
            if (storedArticles.length === 0) {
                return "üìä No articles to analyze yet. Upload some documents first!";
            }
            
            let response = "üìä **Topic Analysis of Your Articles**:\n\n";
            
            // Simple keyword analysis
            const keywords = {};
            storedArticles.forEach(article => {
                const words = article.content.toLowerCase().split(/\s+/);
                words.forEach(word => {
                    if (word.length > 5) {
                        keywords[word] = (keywords[word] || 0) + 1;
                    }
                });
            });
            
            const topKeywords = Object.entries(keywords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            response += "**Most Common Topics/Themes**:\n";
            topKeywords.forEach(([keyword, count], index) => {
                response += `${index + 1}. ${keyword} (appears ${count} times)\n`;
            });
            
            response += "\nüí° Based on your content, you might want to focus your vocabulary practice on academic and professional terminology.";
            
            return response;
        }
        
        function generatePracticeHelp() {
            let response = "üéØ **Vocabulary Practice Recommendations**:\n\n";
            
            if (extractedWords.size === 0) {
                response += "First, extract vocabulary words from your documents on the Main page.\n\n";
            } else {
                response += `You have ${extractedWords.size} vocabulary words ready for practice!\n\n`;
            }
            
            response += "**Practice Options**:\n";
            response += "‚Ä¢ **Fill in the Blanks**: Complete sentences with vocabulary words\n";
            response += "‚Ä¢ **Word Matching**: Match words with their definitions\n";
            response += "‚Ä¢ **Multiple Choice**: Choose the correct word for context\n\n";
            
            response += "**Study Tips**:\n";
            response += "‚Ä¢ Start with 10-15 words per session\n";
            response += "‚Ä¢ Practice regularly for better retention\n";
            response += "‚Ä¢ Use the generated articles for context reading\n";
            response += "‚Ä¢ Focus on words that appear frequently in your documents";
            
            return response;
        }
        
        function generateStatistics() {
            let response = "üìà **Your Learning Statistics**:\n\n";
            
            response += `üìö **Content**:\n`;
            response += `‚Ä¢ Articles uploaded: ${storedArticles.length}\n`;
            response += `‚Ä¢ Total content: ${storedArticles.reduce((sum, article) => sum + article.wordCount, 0).toLocaleString()} words\n\n`;
            
            response += `üî§ **Vocabulary**:\n`;
            response += `‚Ä¢ Unique words extracted: ${extractedWords.size}\n`;
            
            if (Object.keys(wordsByPOS).length > 0) {
                Object.entries(wordsByPOS).forEach(([pos, words]) => {
                    const count = Object.keys(words).length;
                    if (count > 0) {
                        response += `‚Ä¢ ${pos}: ${count} words\n`;
                    }
                });
            }
            
            const avgWordsPerDoc = storedArticles.length > 0 ? 
                Math.round(storedArticles.reduce((sum, article) => sum + article.wordCount, 0) / storedArticles.length) : 0;
            
            response += `\nüìä **Averages**:\n`;
            response += `‚Ä¢ Words per document: ${avgWordsPerDoc.toLocaleString()}\n`;
            
            if (storedArticles.length > 0) {
                const oldestDate = new Date(Math.min(...storedArticles.map(a => new Date(a.timestamp))));
                const daysSince = Math.floor((new Date() - oldestDate) / (1000 * 60 * 60 * 24));
                response += `‚Ä¢ Days since first upload: ${daysSince}\n`;
            }
            
            return response;
        }
        
        function generateSearchResponse(message) {
            const searchTerms = message.toLowerCase().replace(/search|find|show|containing?/g, '').trim();
            
            if (!searchTerms) {
                return "üîç Please specify what you'd like me to search for. For example: 'Find articles containing education' or 'Search for the word research'.";
            }
            
            let response = `üîç **Search Results for "${searchTerms}"**:\n\n`;
            
            // Search in articles
            const matchingArticles = storedArticles.filter(article => 
                article.fileName.toLowerCase().includes(searchTerms) || 
                article.content.toLowerCase().includes(searchTerms)
            );
            
            if (matchingArticles.length > 0) {
                response += `**Found in ${matchingArticles.length} articles**:\n`;
                matchingArticles.slice(0, 5).forEach((article, index) => {
                    response += `${index + 1}. ${article.fileName}\n`;
                });
                
                if (matchingArticles.length > 5) {
                    response += `... and ${matchingArticles.length - 5} more\n`;
                }
            }
            
            // Search in vocabulary
            const matchingWords = Array.from(extractedWords).filter(word => 
                word.includes(searchTerms)
            );
            
            if (matchingWords.length > 0) {
                response += `\n**Matching vocabulary words** (${matchingWords.length} found):\n`;
                matchingWords.slice(0, 10).forEach((word, index) => {
                    response += `‚Ä¢ ${word}\n`;
                });
                
                if (matchingWords.length > 10) {
                    response += `... and ${matchingWords.length - 10} more\n`;
                }
            }
            
            if (matchingArticles.length === 0 && matchingWords.length === 0) {
                response += "No matches found in your uploaded content.";
            }
            
            return response;
        }
        
        function generateDefaultResponse() {
            const responses = [
                "I can help you with your vocabulary learning! Ask me about your uploaded articles, vocabulary words, or practice recommendations.",
                
                "Here are some things you can ask me:\n‚Ä¢ 'List all my articles'\n‚Ä¢ 'Show vocabulary words'\n‚Ä¢ 'What topics do my articles cover?'\n‚Ä¢ 'Help me practice vocabulary'",
                
                "I'm here to assist with your past paper vocabulary learning. I can analyze your uploaded content, show statistics, and provide study recommendations.",
                
                "Feel free to ask me about your learning progress, content analysis, or specific vocabulary words. I remember everything you've uploaded!",
                
                "Need help with vocabulary building? I can show your word lists, analyze document topics, or suggest practice strategies based on your uploaded content."
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function exportChatHistory() {
            const messages = document.getElementById('chatMessages').textContent;
            const blob = new Blob([messages], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Chat_History_${new Date().toLocaleDateString('en-GB').replace(/\//g, '-')}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }
        
        function clearStoredData() {
            if (confirm('Are you sure you want to clear all stored articles and chat history? This cannot be undone.')) {
                storedArticles = [];
                safeSaveToStorage('vocabularyArticles', []);
                
                // Clear chat messages
                document.getElementById('chatMessages').innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 mt-20">
                        <div class="text-4xl mb-4">ü§ñ</div>
                        <p class="text-lg font-medium">Welcome to your Smart Assistant!</p>
                        <p class="text-sm mt-2">Ask me anything about your uploaded content:</p>
                        <div class="text-xs mt-3 space-y-1">
                            <p>‚Ä¢ "What vocabulary words are in [filename]?"</p>
                            <p>‚Ä¢ "Summarize the content about education"</p>
                            <p>‚Ä¢ "Find articles containing the word 'research'"</p>
                            <p>‚Ä¢ "Show me all files uploaded today"</p>
                        </div>
                    </div>
                `;
                
                updateChatPageStats();
                updateStorageStatus();
                alert('All stored data has been cleared.');
            }
        }
        
        // Storage status tracking and display
        function updateStorageStatus() {
            // Try to get an estimate of storage usage
            try {
                const storageEstimate = getStorageEstimate();
                console.log('Current storage estimate:', storageEstimate);
                
                // Show storage status in chat page if visible
                if (!document.getElementById('chatPage').classList.contains('hidden')) {
                    updateChatPageStats();
                }
                
                // Update storage status display
                const statusElement = document.getElementById('storageStatus');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <div class="space-y-1">
                            <div>üìö Articles: ${storageEstimate.articlesCount}</div>
                            <div>üî§ Words: ${storageEstimate.wordsCount}</div>
                            <div>üíæ Storage: ${storageEstimate.summary}</div>
                        </div>
                    `;
                }
                
                // Update any storage indicators
                const statusElements = document.querySelectorAll('[data-storage-status]');
                statusElements.forEach(element => {
                    element.textContent = storageEstimate.summary;
                });
                
            } catch (error) {
                console.log('Storage status check failed:', error);
            }
        }
        
        function getStorageEstimate() {
            try {
                // Calculate approximate storage usage
                const articlesData = JSON.stringify(storedArticles);
                const vocabData = JSON.stringify({
                    words: Array.from(extractedWords),
                    frequency: wordFrequency,
                    wordsByPOS: wordsByPOS
                });
                
                const totalDataSize = articlesData.length + vocabData.length;
                const totalDataMB = (totalDataSize / (1024 * 1024)).toFixed(2);
                
                // Estimate browser localStorage limits (usually 5-10MB)
                const estimatedLimit = 5; // MB
                const usagePercent = Math.round((totalDataMB / estimatedLimit) * 100);
                
                return {
                    totalSizeMB: totalDataMB,
                    usagePercent: Math.min(usagePercent, 100),
                    articlesCount: storedArticles.length,
                    wordsCount: extractedWords.size,
                    summary: `${totalDataMB}MB used (${Math.min(usagePercent, 100)}% of estimated limit)`
                };
                
            } catch (error) {
                return {
                    totalSizeMB: 'Unknown',
                    usagePercent: 0,
                    articlesCount: storedArticles.length,
                    wordsCount: extractedWords.size,
                    summary: 'Storage info unavailable'
                };
            }
        }
        
        // Enhanced data export with multiple formats
        function exportAllData() {
            try {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    articles: storedArticles,
                    vocabulary: {
                        words: Array.from(extractedWords),
                        frequency: wordFrequency,
                        wordsByPOS: wordsByPOS
                    },
                    statistics: {
                        totalArticles: storedArticles.length,
                        totalWords: extractedWords.size,
                        totalContent: storedArticles.reduce((sum, article) => sum + article.wordCount, 0)
                    }
                };
                
                // Create downloadable JSON file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Vocabulary_Builder_Export_${new Date().toLocaleDateString('en-GB').replace(/\//g, '-')}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                return true;
            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed. Please try again.');
                return false;
            }
        }
        
        // Data import functionality
        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validate import data structure
                    if (importData.articles && importData.vocabulary) {
                        // Merge with existing data
                        storedArticles.push(...importData.articles);
                        
                        // Merge vocabulary
                        importData.vocabulary.words.forEach(word => extractedWords.add(word));
                        Object.assign(wordFrequency, importData.vocabulary.frequency);
                        
                        // Merge POS data if available
                        if (importData.vocabulary.wordsByPOS) {
                            Object.entries(importData.vocabulary.wordsByPOS).forEach(([pos, words]) => {
                                if (!wordsByPOS[pos]) wordsByPOS[pos] = {};
                                Object.assign(wordsByPOS[pos], words);
                            });
                        }
                        
                        // Save to storage
                        safeSaveToStorage('vocabularyArticles', storedArticles);
                        safeSaveToStorage('currentVocabulary', {
                            words: Array.from(extractedWords),
                            frequency: wordFrequency,
                            wordsByPOS: wordsByPOS,
                            lastUpdated: new Date().toISOString()
                        });
                        
                        // Update UI
                        displayWordListByPOS();
                        updateProcessButton();
                        updateChatPageStats();
                        updateStorageStatus();
                        
                        alert(`Successfully imported ${importData.articles.length} articles and ${importData.vocabulary.words.length} vocabulary words!`);
                    } else {
                        alert('Invalid import file format. Please use a file exported from this app.');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Failed to import data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }
        
        // Sharing functionality
        function shareData() {
            try {
                const shareData = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    articles: storedArticles,
                    vocabulary: {
                        words: Array.from(extractedWords),
                        frequency: wordFrequency,
                        wordsByPOS: wordsByPOS
                    },
                    statistics: {
                        totalArticles: storedArticles.length,
                        totalWords: extractedWords.size,
                        totalContent: storedArticles.reduce((sum, article) => sum + article.wordCount, 0)
                    }
                };
                
                // Create a shareable code (compressed data)
                const jsonString = JSON.stringify(shareData);
                
                // For browser compatibility, use Base64 encoding
                const encodedData = btoa(encodeURIComponent(jsonString));
                
                // Create share URL
                const shareUrl = `${window.location.origin}${window.location.pathname}?share=${encodedData}`;
                
                // Create shareable content
                const shareText = `üéì Vocabulary Builder Shared Data\n\nüìä Contents:\n‚Ä¢ ${shareData.articles.length} articles\n‚Ä¢ ${shareData.vocabulary.words.length} vocabulary words\n‚Ä¢ ${shareData.statistics.totalContent.toLocaleString()} total words\n\nüîó Load this data in Vocabulary Builder:\n${shareUrl}`;
                
                // Show share modal
                showShareModal(shareUrl, shareText, encodedData);
                
            } catch (error) {
                console.error('Share generation failed:', error);
                alert('Error generating shareable data. Your dataset might be too large. Try exporting as a file instead.');
            }
        }
        
        function showShareModal(shareUrl, shareText, encodedData) {
            // Create modal HTML
            const modalHTML = `
                <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">üîó Share Your Vocabulary Data</h3>
                                <button id="closeShareModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold mb-2">üìã Share URL</h4>
                                    <div class="flex space-x-2">
                                        <input type="text" id="shareUrlInput" value="${shareUrl}" readonly 
                                               class="text-sm flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700">
                                        <button id="copyShareUrl" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm">
                                            üìã Copy
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Anyone with this URL can load your vocabulary data</p>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold mb-2">üí¨ Share Message</h4>
                                    <textarea id="shareTextArea" readonly class="text-sm w-full h-32 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 resize-none">${shareText}</textarea>
                                    <button id="copyShareText" class="mt-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm">
                                        üìã Copy Message
                                    </button>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold mb-2">üîê Share Code</h4>
                                    <div class="flex space-x-2">
                                        <input type="text" id="shareCodeInput" value="${encodedData.substring(0, 50)}..." readonly 
                                               class="text-sm flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700">
                                        <button id="copyShareCode" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md text-sm">
                                            üìã Copy Code
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Alternative: Users can paste this code in "Load Shared Data"</p>
                                </div>
                                
                                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-md">
                                    <h5 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">üìò How to Share:</h5>
                                    <ol class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                                        <li>1. Copy the URL or message above</li>
                                        <li>2. Send it to others via email, messaging, or social media</li>
                                        <li>3. Recipients click the link or use "Load Shared Data" with the code</li>
                                        <li>4. They'll get all your vocabulary words and articles!</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add event listeners
            document.getElementById('closeShareModal').addEventListener('click', closeShareModal);
            document.getElementById('copyShareUrl').addEventListener('click', () => copyToClipboard(shareUrl, 'URL copied!'));
            document.getElementById('copyShareText').addEventListener('click', () => copyToClipboard(shareText, 'Message copied!'));
            document.getElementById('copyShareCode').addEventListener('click', () => copyToClipboard(encodedData, 'Code copied!'));
            
            // Close on outside click
            document.getElementById('shareModal').addEventListener('click', (e) => {
                if (e.target.id === 'shareModal') closeShareModal();
            });
        }
        
        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) modal.remove();
        }
        
        function copyToClipboardSimple(text, successMessage) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert(successMessage);
                }).catch(() => {
                    fallbackCopyToClipboard(text, successMessage);
                });
            } else {
                fallbackCopyToClipboard(text, successMessage);
            }
        }
        
        function fallbackCopyToClipboard(text, successMessage) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                alert(successMessage);
            } catch (err) {
                alert('Please manually copy the text');
            }
            document.body.removeChild(textArea);
        }
        
        function loadSharedData() {
            const modalHTML = `
                <div id="loadShareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-lg w-full">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">üì• Load Shared Data</h3>
                                <button id="closeLoadModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Paste Share Code or URL:</label>
                                    <textarea id="shareCodeTextarea" placeholder="Paste the shared code or URL here..." 
                                              class="text-base w-full h-32 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 resize-none"></textarea>
                                </div>
                                
                                <div class="flex space-x-3">
                                    <button id="loadSharedDataBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md">
                                        üì• Load Data
                                    </button>
                                    <button id="cancelLoadBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md">
                                        Cancel
                                    </button>
                                </div>
                                
                                <div class="bg-yellow-50 dark:bg-yellow-900 p-3 rounded-md">
                                    <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                        <strong>Note:</strong> This will add the shared data to your existing vocabulary words and articles.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Event listeners
            document.getElementById('closeLoadModal').addEventListener('click', closeLoadModal);
            document.getElementById('cancelLoadBtn').addEventListener('click', closeLoadModal);
            document.getElementById('loadSharedDataBtn').addEventListener('click', processSharedData);
            
            // Close on outside click
            document.getElementById('loadShareModal').addEventListener('click', (e) => {
                if (e.target.id === 'loadShareModal') closeLoadModal();
            });
        }
        
        function closeLoadModal() {
            const modal = document.getElementById('loadShareModal');
            if (modal) modal.remove();
        }
        
        function processSharedData() {
            const input = document.getElementById('shareCodeTextarea').value.trim();
            if (!input) {
                alert('Please paste a share code or URL first.');
                return;
            }
            
            try {
                let encodedData = input;
                
                // Extract data from URL if provided
                if (input.includes('?share=')) {
                    const urlParams = new URLSearchParams(input.split('?')[1]);
                    encodedData = urlParams.get('share');
                }
                
                // Decode the data
                const jsonString = decodeURIComponent(atob(encodedData));
                const sharedData = JSON.parse(jsonString);
                
                // Validate data structure
                if (!sharedData.articles || !sharedData.vocabulary) {
                    throw new Error('Invalid share data format');
                }
                
                // Merge with existing data
                const articlesAdded = sharedData.articles.length;
                const wordsAdded = sharedData.vocabulary.words.filter(word => !extractedWords.has(word)).length;
                
                storedArticles.push(...sharedData.articles);
                
                // Merge vocabulary
                sharedData.vocabulary.words.forEach(word => extractedWords.add(word));
                Object.assign(wordFrequency, sharedData.vocabulary.frequency);
                
                // Merge POS data if available
                if (sharedData.vocabulary.wordsByPOS) {
                    Object.entries(sharedData.vocabulary.wordsByPOS).forEach(([pos, words]) => {
                        if (!wordsByPOS[pos]) wordsByPOS[pos] = {};
                        Object.assign(wordsByPOS[pos], words);
                    });
                }
                
                // Save to storage
                safeSaveToStorage('vocabularyArticles', storedArticles);
                safeSaveToStorage('currentVocabulary', {
                    words: Array.from(extractedWords),
                    frequency: wordFrequency,
                    wordsByPOS: wordsByPOS,
                    lastUpdated: new Date().toISOString()
                });
                
                // Update UI
                displayWordListByPOS();
                updateProcessButton();
                updateChatPageStats();
                updateStorageStatus();
                
                closeLoadModal();
                alert(`Successfully loaded shared data!\n‚Ä¢ ${articlesAdded} articles added\n‚Ä¢ ${wordsAdded} new vocabulary words added`);
                
            } catch (error) {
                console.error('Error loading shared data:', error);
                alert('Error loading shared data. Please check the code/URL and try again.');
            }
        }
        
        // Check for shared data in URL on page load
        function checkForSharedDataInURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('share');
            
            if (sharedData) {
                // Auto-load shared data
                setTimeout(() => {
                    if (confirm('This link contains shared vocabulary data. Would you like to load it?')) {
                        try {
                            const jsonString = decodeURIComponent(atob(sharedData));
                            const data = JSON.parse(jsonString);
                            
                            // Same loading logic as processSharedData
                            const articlesAdded = data.articles.length;
                            const wordsAdded = data.vocabulary.words.filter(word => !extractedWords.has(word)).length;
                            
                            storedArticles.push(...data.articles);
                            data.vocabulary.words.forEach(word => extractedWords.add(word));
                            Object.assign(wordFrequency, data.vocabulary.frequency);
                            
                            if (data.vocabulary.wordsByPOS) {
                                Object.entries(data.vocabulary.wordsByPOS).forEach(([pos, words]) => {
                                    if (!wordsByPOS[pos]) wordsByPOS[pos] = {};
                                    Object.assign(wordsByPOS[pos], words);
                                });
                            }
                            
                            safeSaveToStorage('vocabularyArticles', storedArticles);
                            safeSaveToStorage('currentVocabulary', {
                                words: Array.from(extractedWords),
                                frequency: wordFrequency,
                                wordsByPOS: wordsByPOS,
                                lastUpdated: new Date().toISOString()
                            });
                            
                            displayWordListByPOS();
                            updateProcessButton();
                            updateChatPageStats();
                            updateStorageStatus();
                            
                            alert(`Successfully loaded shared data!\n‚Ä¢ ${articlesAdded} articles loaded\n‚Ä¢ ${wordsAdded} new vocabulary words added`);
                            
                            // Clean URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                            
                        } catch (error) {
                            console.error('Error auto-loading shared data:', error);
                            alert('Error loading shared data from URL.');
                        }
                    } else {
                        // Clean URL if user declines
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }, 1000);
            }
        }
        
        // Load stored data on page load
        function loadStoredData() {
            try {
                // Load articles
                storedArticles = safeGetFromStorage('vocabularyArticles', []);
                
                // Load vocabulary
                const storedVocabulary = safeGetFromStorage('currentVocabulary', null);
                if (storedVocabulary) {
                    extractedWords = new Set(storedVocabulary.words || []);
                    wordFrequency = storedVocabulary.frequency || {};
                    wordsByPOS = storedVocabulary.wordsByPOS || {
                        'Nouns': {},
                        'Verbs': {},
                        'Adjectives': {},
                        'Adverbs': {},
                        'Other': {}
                    };
                    
                    console.log(`Loaded ${extractedWords.size} vocabulary words from storage`);
                    
                    // Update UI if words were loaded
                    if (extractedWords.size > 0) {
                        displayWordListByPOS();
                        updateProcessButton();
                    }
                }
                
                console.log(`Loaded ${storedArticles.length} articles from storage`);
                updateStorageStatus();
                
            } catch (error) {
                console.log('Error loading stored data:', error);
            }
        }
        
        // Auto-save functionality
        function enableAutoSave() {
            // Save vocabulary data periodically
            setInterval(() => {
                if (extractedWords.size > 0) {
                    safeSaveToStorage('currentVocabulary', {
                        words: Array.from(extractedWords),
                        frequency: wordFrequency,
                        wordsByPOS: wordsByPOS,
                        lastUpdated: new Date().toISOString()
                    });
                }
            }, 30000); // Save every 30 seconds
        }
        
        // Initialize storage on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredData();
            enableAutoSave();
        });
    </script>
</body>
</html>